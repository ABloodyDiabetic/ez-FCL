var freeaps_determineBasal;(()=>{var e={2982:(e,r,a)=>{var t=a(3531);function o(e,r){r||(r=0);var a=Math.pow(10,r);return Math.round(e*a)/a}function n(e,r){return"mmol/L"===r.out_units?o(.0555*e,1):Math.round(e)}e.exports=function(e,r,a,i,s,l,d,u,m,c,_,p,f,b,g){var h=0,B="",v="",M="",x="",y="",S=0,I=0,w=0,F=0,T=0,D=0;const C=b.tddYtd,O=b.tdd7d,G=b.hbt,U=b.isEnabled,A=e.avgdelta;function z(e,r){var a=e.getTime();return new Date(a+36e5*r)}function P(e){var r=i.bolus_increment;.025!=r&&(r=.05);var a=e/r;return a>=1?o(Math.floor(a)*r,5):0}function R(e){function r(e){return e<10&&(e="0"+e),e}return r(e.getHours())+":"+r(e.getMinutes())+":00"}function E(e,r){var a=new Date("1/1/1999 "+e),t=new Date("1/1/1999 "+r);return(a.getTime()-t.getTime())/36e5}function k(e,r){var a=0,t=r,o=(e-r)/36e5,n=0,i=o,s=0;do{if(o>0){var l=R(t);f[0].rate;for(let e=0;e<f.length;e++){var d=f[e].start;if(l==d){if(e+1<f.length){o>=(s=E(f[e+1].start,f[e].start))?n=s:o<s&&(n=o)}else if(e+1==f.length){let r=f[0].start;o>=(s=24-E(f[e].start,r))?n=s:o<s&&(n=o)}a+=P(f[e].rate*n),o-=n,t=z(t,n)}else if(l>d)if(e+1<f.length){var u=f[e+1].start;l<u&&(o>=(s=E(u,l))?n=s:o<s&&(n=o),a+=P(f[e].rate*n),o-=n,t=z(t,n))}else if(e==f.length-1){o>=(s=E("23:59:59",l))?n=s:o<s&&(n=o),a+=P(f[e].rate*n),o-=n,t=z(t,n)}}}}while(o>0&&o<i);return a}if(_.length){let e=_.length-1;var L=new Date(_[e].timestamp),j=new Date(_[0].timestamp);if("TempBasalDuration"==_[0]._type&&(j=new Date),(h=(j-L)/36e5)<23.9&&h>21)T=k(L,(q=24-h,W=L.getTime(),new Date(W-36e5*q))),x="24 hours of data is required for an accurate tdd calculation. Currently only "+h.toPrecision(3)+" hours of pump history data are available. Using your pump scheduled basals to fill in the missing hours. Scheduled basals added: "+T.toPrecision(5)+" U. ";else x=""}else console.log("Pumphistory is empty!"),dynISFenabled=!1,enableDynamicCR=!1;var q,W,H=0,N=0;o((new Date(Ge).getTime()-l.lastBolusNormalTime)/6e4,1);for(let e=0;e<_.length;e++)if("Bolus"==_[e]._type&&(F+=_[e].amount,0==H&&_[e].amount>=i.iTime_Start_Bolus)){H=t(_[e].amount,i);var X=new Date(_[e].timestamp);N=o((new Date-X)/36e5*60)}for(let e=1;e<_.length;e++)if("TempBasal"==_[e]._type&&_[e].rate>0){S=e,D=_[e].rate;var Y=_[e-1]["duration (min)"]/60,V=Y,Z=new Date(_[e-1].timestamp),$=Z;do{if(e--,0==e){$=new Date;break}if("TempBasal"==_[e]._type||"PumpSuspend"==_[e]._type){$=new Date(_[e].timestamp);break}}while(e>0);var J=($-Z)/36e5;J<V&&(Y=J),w+=P(D*Y),e=S}for(let e=0;e<_.length;e++)if(0,0==_[e]["duration (min)"]||"PumpResume"==_[e]._type){let r=new Date(_[e].timestamp),a=r,t=e;do{if(t>0&&(--t,"TempBasal"==_[t]._type)){a=new Date(_[t].timestamp);break}}while(t>0);(a-r)/36e5>0&&(T+=k(a,r))}for(let e=_.length-1;e>0;e--)if("TempBasalDuration"==_[e]._type){let r=_[e]["duration (min)"]/60,a=new Date(_[e].timestamp);var K=a;let t=e;do{if(--t,t>=0&&("TempBasal"==_[t]._type||"PumpSuspend"==_[t]._type)){K=new Date(_[t].timestamp);break}}while(t>0);if(0==e&&"TempBasalDuration"==_[0]._type&&(K=new Date,r=_[e]["duration (min)"]/60),(K-a)/36e5-r>0){T+=k(K,z(a,r))}}var Q={TDD:o(I=F+w+T,5),bolus:o(F,5),temp_basal:o(w,5),scheduled_basal:o(T,5)},ee=I;function re(e,r){const a=1700/e.calculate_isf_from_tdd_numerator_divisor/I;return e.use_autosens_isf_to_calculate_auto_isf_sens?a:e.sens}function ae(e,r){const a=e.current_basal,t=e.sens,o=1700/e.calculate_isf_from_tdd_numerator_divisor/I;if(e.use_autosens_isf_to_calculate_auto_isf_sens){let r=a*(t/o);return r=Math.max(0,.05*Math.round(r*e.basal_multiplier/.05)),r}return a}function te(e,r,a){const t=r.glucose;if(e.enable_max_iob_deadbands){const r=e.tight_deadband_range/100*a+a,o=e.loose_deadband_range/100*a+a;if(t>=0&&t<r&&!e.moderate_carb_ez_fcl_profile&&!e.high_carb_ez_fcl_profile)return e.max_iob_tight_deadband/100*I;if(t>=r&&t<=o&&!e.moderate_carb_ez_fcl_profile&&!e.high_carb_ez_fcl_profile)return e.max_iob_loose_deadband/100*I;if(t>=r&&e.sleep_mode)return e.max_iob_tight_deadband/100*I;if(t>=r&&e.automatic_sleep_mode)return e.max_iob_tight_deadband/100*I}return e.max_iob/100*O}h>21?(v=". Bolus insulin: "+F.toPrecision(5)+" U",M=". Temporary basal insulin: "+w.toPrecision(5)+" U",B=". Insulin with scheduled basal rate: "+T.toPrecision(5)+" U",y=x+(" TDD past 24h is: "+I.toPrecision(5)+" U")+v+M+B,tddReason=", TDD, 24h: "+o(I,1)+", ytd: "+o(C,1)+", 7dØ: "+o(O,1),console.error(y)):tddReason=", TDD: Not enough pumpData (< 21h)";var oe="",ne="",ie="",se="",le="",de="",ue="",me="",ce="",_e="",pe="",fe="",be="",ge=1,he=1,Be=1,ve=1,Me=1,xe=1,ye=100;function Se(e,r,a){"bg"==a?(polyX=[50,60,80,90,100,110,150,180,200],polyY=[-.5,-.5,-.3,-.2,0,0,.5,.7,.7]):"delta"==a&&(polyX=[2,7,12,16,20],polyY=[0,0,.4,.7,.7]);var t=polyX.length-1,o=polyX[0],n=polyY[0],i=polyX[t],s=polyY[t],l=1,d=1,u=1,m=o;if(o>e)i=polyX[1],l=(d=n)+((s=polyY[1])-d)/(i-(u=o))*(e-u);else if(i<e)o=polyX[t-1],l=(d=n=polyY[t-1])+(s-d)/(i-(u=o))*(e-u);else for(var c=0;c<=t;c++){if(o=polyX[c],n=polyY[c],o==e){l=n;break}if(o>e){l=d+(n-d)/(o-(u=m))*(e-u);break}d=n,m=o}return l*="delta"==a?r.delta_ISFrange_weight:e>100?r.higher_ISFrange_weight:r.lower_ISFrange_weight}function Ie(e,r,a,t,n,i,s,l,d){console.error("check ratio "+o(e,2)+" against autoISF min: "+r+" and autoISF max: "+a),e<r?(ce=" (lmtd.min)",ue="weakest autoISF factor "+o(e,2)+" limited by autoISF_min "+r,console.error(ue),e=r):e>a&&(ce=" (lmtd.max)",ue="strongest autoISF factor "+o(e,2)+" limited by autoISF_max "+a,console.error(ue),e=a);var u=1;return s&&i.temptargetSet&&l>d?(u=e*t,n=" (exerciseMode)",console.error("autoISF adjusts sens "+t+", instead of getSensValue(profile) "+re(i)),_e=n):e>=1?(u=Math.max(e,t),e>=t&&(n="")):(u=Math.min(e,t),e<=t&&(n="")),ue="final ISF factor "+o(u,2)+n,console.error(ue),u}var we={},Fe=0,Te=0,De=new Date;if(c&&(De=new Date(c)),void 0===i||void 0===ae(i))return we.error="Error: could not get current basal rate",we;var Ce=t(ae(i),i),Oe=Ce,Ge=new Date;c&&(Ge=new Date(c));var Ue,Ae=new Date(e.date),ze=o((Ge-Ae)/60/1e3,1),Pe=e.glucose,Re=e.noise;Ue=n(e.delta,i);var Ee=Math.min(e.delta,e.short_avgdelta),ke=Math.min(e.short_avgdelta,e.long_avgdelta),Le=Math.max(e.delta,e.short_avgdelta,e.long_avgdelta);(Pe<=10||38===Pe||Re>=3)&&(we.reason="CGM is calibrating, in ??? state, or noise is high");if(ze>12||ze<-5?we.reason="If current system time "+Ge+" is correct, then BG data is too old. The last BG data was read "+ze+"m ago at "+Ae:Pe>60&&e.cgmFlatMinutes>89&&e.last_cal&&e.last_cal<3&&(we.reason="CGM was just calibrated"),Pe<=10||38===Pe||Re>=3||ze>12||ze<-5||Pe>60&&e.cgmFlatMinutes>89||0===e.short_avgdelta&&0===e.long_avgdelta)return r.rate>Oe?(we.reason+=". Replacing high temp basal of "+r.rate+" with neutral temp of "+Oe,we.deliverAt=De,we.temp="absolute",we.duration=30,we.rate=Oe,we):0===r.rate&&r.duration>30?(we.reason+=". Shortening "+r.duration+"m long zero temp to 30m. ",we.deliverAt=De,we.temp="absolute",we.duration=30,we.rate=0,we):(we.reason+=". Temp "+r.rate+" <= current basal "+o(Oe,2)+"U/hr; doing nothing. ",we);var je,qe,We,He;te(i,e,je);if(void 0!==i.min_bg&&(qe=i.min_bg),void 0!==i.max_bg&&(We=i.max_bg),void 0!==i.enableSMB_high_bg_target&&(He=i.enableSMB_high_bg_target),void 0===i.min_bg||void 0===i.max_bg)return we.error="Error: could not determine target_bg. ",we;je=(i.min_bg+i.max_bg)/2;var Ne=1,Xe="",Ye=i.exercise_mode||i.high_temptarget_raises_sensitivity,Ve=100,Ze=160;i.half_basal_exercise_target&&(Ze=i.half_basal_exercise_target),U&&(Ze=G);var $e=1;if(Ye&&i.temptargetSet&&je>Ve||i.low_temptarget_lowers_sensitivity&&i.temptargetSet&&je<Ve){var Je=Ze-Ve;Ne=Je*(Je+je-Ve)<=0?i.autosens_max:Je/(Je+je-Ve),$e=Ne=o(Ne=Math.min(Ne,i.autosens_max),2),Xe=" from TT modifier",pe+=", Ratio TT: "+Ne,process.stderr.write("Sensitivity ratio set to "+Ne+" based on temp target of "+je+"; ")}else void 0!==s&&s&&i.enable_autosens&&!i.use_autosens_isf_to_calculate_auto_isf_sens&&(Xe=" from Autosens",be=", autosens:, "+o(Ne=s.ratio,2),process.stderr.write("Autosens ratio: "+Ne+"; "));var Ke=$e;if(Ne&&(Oe=ae(i)*Ne,(Oe=t(Oe,i))!==Ce?process.stderr.write("Adjusting basal from "+Ce+" to "+Oe+"; "):process.stderr.write("Basal unchanged: "+Oe+"; ")),i.temptargetSet);else if(void 0!==s&&s&&(i.sensitivity_raises_target&&s.ratio<1||i.resistance_lowers_target&&s.ratio>1)){qe=o((qe-60)/s.ratio)+60,We=o((We-60)/s.ratio)+60;var Qe=o((je-60)/s.ratio)+60;Qe=Math.max(80,Qe),je===Qe?process.stderr.write("target_bg unchanged: "+Qe+"; "):process.stderr.write("target_bg from "+je+" to "+Qe+"; "),je=Qe}var er=200,rr=200,ar=200;if(e.noise>=2){var tr=Math.max(1.1,i.noisyCGMTargetMultiplier);Math.min(250,i.maxRaw);er=o(Math.min(200,qe*tr)),rr=o(Math.min(200,je*tr)),ar=o(Math.min(200,We*tr)),process.stderr.write("Raising target_bg for noisy / raw CGM data, from "+je+" to "+rr+"; "),qe=er,je=rr,We=ar}var or=.5;i.smb_threshold_ratio>.5&&i.smb_threshold_ratio<=1&&(or=i.smb_threshold_ratio);var nr=qe-(1-or)*(qe-40);console.log("MB Threshold set to "+or+" - no MB's applied below "+n(nr,i));var ir=o(re(i),1),sr=re(i);void 0!==s&&s&&((sr=o(sr=re(i)/Ne,1))!==ir?process.stderr.write("ISF from "+n(ir,i)+" to "+n(sr,i)):process.stderr.write("ISF unchanged: "+n(sr,i))),console.error("CR: "+i.carb_ratio),console.error("----------------------------------"),console.error(" start autoISF"),console.error("----------------------------------");var lr=!0,dr=!1,ur=r.rate,mr=i.b30_duration,cr=mr+1;if(console.error("B30 enabled: "+i.use_B30),i.use_B30&&i.use_autoisf){var _r=i.iTime_Start_Bolus,pr=i.iTime_target,fr=i.b30_upperBG,br=i.b30_upperdelta,gr=i.b30_factor,hr=!1;i.temptargetSet&&(hr=!0);var Br=N;0==Br&&(Br=1);var vr=H;console.error("B30 last bolus above limit of "+_r+"U was "+vr+"U, "+Br+"m ago"),vr>=_r&&Br<=mr&&hr&&je==pr&&(cr=Br,dr=!0,console.error("B30 iTime is running : "+cr+"m because manual bolus ("+vr+") >= Minimum Start Bolus size ("+_r+") and EatingSoon TT set at "+n(pr,i))),console.error("B30 Activation: "+dr),console.error("B30 TTset: "+hr+", at "+je+", last Bolus of "+vr+"U, "+Br+"m ago. iTime remaining: "+(mr-cr)+"m."),dr&&(e.delta<=br&&Pe<fr&&(lr=!1),cr<=mr&&(fe="AIMI B30, Temp "+(ur=t(Oe*gr,i))+"U/hr for "+(mr-cr)+"m, "))}var Mr=function(r,a,t,i,s){if(void 0===t)return we.error="Error: iob_data undefined. ",we;var l=t;if(t.length,t.length>1&&(t=l[0]),void 0===t.activity||void 0===t.iob)return we.error="Error: iob_data missing some property. ",we;if(!i)return ne=", ezFCL-MB disabled:, B30 running","AIMI B30";if(!r)return"oref";var d=n(a.min_bg,a);if(a.use_autoisf&&a.temptargetSet&&a.enableSMB_EvenOn_OddOff||a.use_autoisf&&a.min_bg==a.max_bg&&a.enableSMB_EvenOn_OddOff_always&&!a.temptargetSet){a.temptargetSet?msgType="TempTarget ":msgType="ProfileTarget ","mmol/L"==a.out_units?(evenTarget=o(10*d,0)%2==0,msgUnits=" has ",msgTail=" decimal"):(evenTarget=d%2==0,msgUnits=" is ",msgTail=" number"),evenTarget?msgEven="even":msgEven="odd",a.iob_threshold_percent<100&&a.iob_threshold_percent>0&&(ye=a.iob_threshold_percent);var u=ye;return evenTarget?0==te(a,e,je)?(console.error("MB disabled because of maxIOB=0"),"blocked"):u/100<t.iob/(te(a,e,je)*s)?(console.error("iobTH: "+o(u,1)+"%, IOB% of maxIOB at "+o(t.iob/(te(a,e,je)*s)*100,1)+"%"),1!=s?(console.error("Full Loop modified maxIOB "+te(a,e,je)+" to effectively "+o(te(a,e,je)*s,2)+" due to profile % and/or exercise mode"),", effective maxIOB "+o(te(a,e,je)*s,2)):", maxIOB "+te(a,e,je),ne=", ezFCL-MB disabled:, iobTH exceeded",console.error("MB disabled by Full Loop logic: IOB "+t.iob+" is more than "+u+"% of maxIOB "+te(a,e,je)),console.error("Full Loop capped"),"iobTH"):(console.error("MB enabled - "+msgType+d+msgUnits+msgEven+msgTail),d<100?(console.error("iobTH: "+o(u,1)+"%, IOB% of maxIOB at "+o(t.iob/(te(a,e,je)*s)*100,1)+"%"),console.error("Loop at full power"),ne=", ezFCL-MB enabled:, even TT","fullLoop"):(console.error("iobTH: "+o(u,1)+"%, IOB% of maxIOB at "+o(t.iob/(te(a,e,je)*s)*100,1)+"%"),ne=", ezFCL-MB enabled:, even Target",console.error("Loop at medium power"),"enforced")):(console.error("MB disabled - "+msgType+d+msgUnits+msgEven+msgTail),ne=", ezFCL-MB disabled:, odd Target",console.error("Loop at minimum power"),"blocked")}return console.error("Full Loop disabled"),"oref"}(u,i,a,lr,Ke),xr=!1;if(u&&"oref"!=Mr?("enforced"!=Mr&&"fullLoop"!=Mr||(xr=!0),console.error("loop_smb function overriden with autoISF checks, enableMB = "+xr)):(xr=function(e,r,a,t,o,i,s){return r?!e.allowSMB_with_high_temptarget&&e.temptargetSet&&o>100?(console.error("MB disabled due to high temptarget of "+o),!1):!0===a.bwFound&&!1===e.A52_risk_enable?(console.error("MB disabled due to Bolus Wizard activity in the last 6 hours."),!1):!0===e.sleep_mode&&e.disable_mb_during_sleep||!0===e.automatic_sleep_mode&&e.disable_mb_during_sleep?(console.error("MB disabled due to sleep mode."),!1):!0===e.enableSMB_always?(a.bwFound?console.error("Warning: MB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("MB enabled due to enable MBs"),!0):!0===e.enableSMB_with_COB&&a.mealCOB?(a.bwCarbs?console.error("Warning: MB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("MB enabled for COB of"+a.mealCOB),!0):!0===e.enableSMB_after_carbs&&a.carbs?(a.bwCarbs?console.error("Warning: MB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("MB enabled for 6h after carb entry"),!0):!0===e.enableSMB_with_temptarget&&e.temptargetSet&&o<100?(a.bwFound?console.error("Warning: MB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("MB enabled for temptarget of "+n(o,e)),console.error("MB enabled for temptargets with "+n(o,e)),!0):!0===e.enableSMB_high_bg&&null!==i&&t>=i?(console.error("Checking BG to see if High for MB enablement."),console.error("Current BG",t," | High BG ",i),a.bwFound?console.error("Warning: High BG MB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("High BG detected. Enabling MB."),!0):(console.error("MB disabled (no enableMB preferences active or no condition satisfied)"),!1):(console.error("MB disabled (!microBolusAllowed)"),!1)}(i,u,l,Pe,je,He),console.error("loop_smb function returns enableMB = "+xr)),sr=function(e,r,a,t,i,s,l,d,u,m,c,_){if(!t.use_autoisf)return console.error("autoISF disabled in Preferences"),oe+=", autoISF disabled",e;if(t.autoISF_off_Sport&&(t.high_temptarget_raises_sensitivity||t.exercise_mode)&&t.temptargetSet&&a>_)return console.error("autoISF disabled due to exercise"),oe+=", autoISF disabled (exercise)",e;const p=i.dura_p,f=i.delta_pl,b=i.delta_pn,g=i.r_squ,h=i.bg_acceleration,B=i.a_0,v=i.a_1,M=i.a_2,x=i.dura_ISF_minutes,y=i.dura_ISF_average;t.autoISF_min;var S=t.autoISF_max,I=!1,w=e,F=a+10-i.glucose,T=i.pp_debug;if("bg_acceleration: "+o(h,3)+", PF-minutes: "+p+", PF-corr: "+o(g,4)+", PF-nextDelta: "+n(b,t)+", PF-lastDelta: "+n(f,t)+", regular Delta: "+n(i.delta,t),console.error(T),t.enable_BG_acceleration){var D=g;if(0!=M&&D>=.9){var C=-v/2/M*5,O=o(B-C*C/25*M,1);(C=o(C,1))>0&&h<0?(me="predicts a Max of "+n(O,t)+", in about "+Math.abs(C)+"min",console.error("Parabolic fit "+me)):C>0&&h>0?(me="predicts a Min of "+n(O,t)+", in about "+Math.abs(C)+"min",console.error("Parabolic fit "+me),C<=30&&O<a&&(he=-t.bgBrake_ISF_weight,me="predicts BG below target soon, applying bgBrake ISF weight of "+-he,console.error("Parabolic fit "+me))):C<0&&h<0?(me="saw Max of "+n(O,t)+", about "+Math.abs(C)+"min ago",console.error("Parabolic fit "+me)):C<0&&h>0&&(me="saw Min of "+n(O,t)+", about "+Math.abs(C)+"min ago",console.error("Parabolic fit "+me))}if(D<.9)me="acce-ISF by-passed, as correlation, "+o(D,2)+", is too low",console.error("Parabolic fit "+me),de+=", Parabolic Fit:, "+me;else{var G=10*(D-.9),U=1;1==he&&i.glucose<t.target_bg?h>0?(h>1&&(U=.5),he=t.bgBrake_ISF_weight):h<0&&(he=t.bgAccel_ISF_weight):1==he&&(h<0?he=t.bgBrake_ISF_weight:h>0&&(he=t.bgAccel_ISF_weight)),(ge=1+h*U*he*G)<0&&(ge=.1),console.error(de+"acce-ISF adaptation is "+o(ge,2)),1!=ge&&(I=!0,de+=", Parabolic Fit:, "+me+", acce-ISF Ratio:, "+o(ge,2))}}else console.error("autoISF BG accelertion adaption disabled in Preferences");oe+=ne+de+", autoISF",Be=1+Se(100-F,t,"bg"),console.error("bg_ISF adaptation is "+o(Be,2));var A=1,z=1;if(Be<1){A=Math.min(Be,ge),ge>1?(ue="bg-ISF adaptation lifted to "+o(A=Be*ge,2)+", as BG accelerates already",console.error(ue),oe+=", bg-ISF Ratio: "+o(A,2)+"(accel.)"):oe+=", bg-ISF Ratio: "+o(A,2)+"(minimal)";let e=1;const i=A;return e=t.low_carb_ez_fcl_profile?(i-1)*t.low_carb_ez_fcl_profile_multiplier+1:t.moderate_carb_ez_fcl_profile?(i-1)*t.moderate_carb_ez_fcl_profile_multiplier+1:t.high_carb_ez_fcl_profile?(i-1)*t.high_carb_ez_fcl_profile_multiplier+1:i,z=Ie(e,t.autoISF_min,S,u,r,t,c,a,_),w=Math.min(720,o(re(t)/z,1)),oe+=", final Ratio: "+o(z,2)+_e+ce+", final ISF: "+function(e,r){return e.use_autosens_isf_to_calculate_auto_isf_sens?n(e.sens,e)+"→"+n(re(e),e)+"→"+n(w,e):n(e.sens,e)+"→"+n(w,e)}(t),w}Be>1&&(I=!0,oe+=", bg-ISF Ratio: "+o(Be,2));var P=i.delta,R=new Date,E="";l&&(R=new Date(l)),t.enable_pp_ISF_always||t.pp_ISF_hours>=(R-new Date(s.lastCarbTime))/1e3/3600?deltaType="pp":deltaType="delta",F>0?console.error(deltaType+"_ISF adaptation by-passed as average glucose < "+a+"+10"):i.short_avgdelta<0?console.error(deltaType+"_ISF adaptation by-passed as no rise or too short lived"):"pp"==deltaType?(Me=1+Math.max(0,P*t.pp_ISF_weight),t.enable_pp_ISF_always||(E=", last Meal "+o((R-s.lastCarbTime)/1e3/3600,1)+" hrs ago is within Range of "+t.pp_ISF_hours+" hrs."),console.error("pp_ISF adaptation is "+o(Me,2)+E),se=", Δ-ISF Ratio: "+o(Me,2),1!=Me&&(I=!0)):(ve=Se(P,t,"delta"),F>-20&&(ve*=.5),ve=1+ve,console.error("delta_ISF adaptation is "+o(ve,2)),le=", Δ-ISF Ratio: "+o(ve,2),1!=ve&&(I=!0));var k=t.dura_ISF_weight;if(s.mealCOB>0&&!t.enableautoisf_with_COB)console.error("dura_ISF by-passed; preferences disabled mealCOB of "+o(s.mealCOB,1));else if(x<10)console.error("dura_ISF by-passed; BG is only "+x+"m at level "+y);else if(y<=a)console.error("dura_ISF by-passed; avg. glucose "+y+" below target "+n(a,t));else{xe+=x/60*(k/a)*(y-a),I=!0,ie=", Duration: "+x+", Avg: "+n(y,t)+", --- ISF Ratio: "+o(xe,2),console.error("dura_ISF adaptation is "+o(xe,2)+" because ISF "+e+" did not do it for "+o(x,1)+"m")}if(I){A=Math.max(xe,Be,ve,ge,Me),console.error("autoISF adaption ratios:"),console.error("  acce "+o(ge,2)),console.error("  bg "+o(Be,2)),console.error("  --- "+o(xe,2)),console.error("  Δ "+o(Me,2)),console.error("  delta "+o(ve,2)),ge<1&&(ue="strongest autoISF factor "+o(A,2)+" weakened to "+o(A*ge,2)+" as bg decelerates already",console.error(ue),A*=ge);let e=1;const i=A;return e=t.low_carb_ez_fcl_profile?(i-1)*t.low_carb_ez_fcl_profile_multiplier+1:t.moderate_carb_ez_fcl_profile?(i-1)*t.moderate_carb_ez_fcl_profile_multiplier+1:t.high_carb_ez_fcl_profile?(i-1)*t.high_carb_ez_fcl_profile_multiplier+1:i,z=Ie(e,t.autoISF_min,S,u,r,t,c,a,_),w=o(re(t)/z,1),oe+=se+le+ie+", final Ratio: "+o(z,2)+_e+ce+", final ISF: "+function(e,r){return e.use_autosens_isf_to_calculate_auto_isf_sens?n(e.sens,e)+"→"+n(re(e),e)+"→"+n(w,e):n(e.sens,e)+"→"+n(w,e)}(t),w}return oe+=", not modified",console.error("autoISF does not modify"),w}(sr,Xe,je,i,e,l,c,0,Ne,0,Ye,Ve),console.error("----------------------------------"),console.error(" end autoISF"),console.error("----------------------------------"),void 0===a)return we.error="Error: iob_data undefined. ",we;var yr,Sr=a;if(a.length,a.length>1&&(a=Sr[0]),void 0===a.activity||void 0===a.iob)return we.error="Error: iob_data missing some property. ",we;var Ir=((yr=void 0!==a.lastTemp?o((new Date(Ge).getTime()-a.lastTemp.date)/6e4):0)+r.duration)%30;if(console.error("currenttemp:"+r.rate+" lastTempAge:"+yr+"m, tempModulus:"+Ir+"m"),we.temp="absolute",we.deliverAt=De,u&&r&&a.lastTemp&&r.rate!==a.lastTemp.rate&&yr>10&&r.duration)return we.reason="Warning: currenttemp rate "+r.rate+" != lastTemp rate "+a.lastTemp.rate+" from pumphistory; canceling temp",d.setTempBasal(0,0,i,we,r);if(r&&a.lastTemp&&r.duration>0){var wr=yr-a.lastTemp.duration;if(wr>5&&yr>10)return we.reason="Warning: currenttemp running but lastTemp from pumphistory ended "+wr+"m ago; canceling temp",d.setTempBasal(0,0,i,we,r)}var Fr=o(-a.activity*sr*5,2),Tr=o(6*(Ee-Fr));Tr<0&&(Tr=o(6*(ke-Fr)))<0&&(Tr=o(6*(e.long_avgdelta-Fr)));var Dr=Pe,Cr=(Dr=a.iob>0?o(Pe-a.iob*sr):o(Pe-a.iob*Math.min(sr,re(i))))+Tr;if(void 0===Cr||isNaN(Cr))return we.error="Error: could not calculate eventualBG. Sensitivity: "+sr+" Deviation: "+Tr,we;var Or=function(e,r,a){return o(a+(e-r)/24,1)}(je,Cr,Fr);we={temp:"absolute",bg:n(Pe,i),tick:Ue,eventualBG:Cr,insulinReq:0,reservoir:m,deliverAt:De,sensitivityRatio:Ne,TDD:ee,insulin:Q,avgDelta:n(A,i)};var Gr=[],Ur=[],Ar=[],zr=[];Gr.push(Pe),Ur.push(Pe),zr.push(Pe),Ar.push(Pe);var Pr=i.enableUAM,Rr=0,Er=0;Rr=o(Ee-Fr,1);var kr=o(Ee-Fr,1);csf=sr/i.carb_ratio,console.error("profile.sens:"+n(re(i),i)+", sens:"+n(sr,i)+", CSF:"+o(csf,1));var Lr=o(30*csf*5/60,1);Rr>Lr&&(console.error("Limiting carb impact from "+Rr+" to "+Lr+"mg/dL/5m (30g/h)"),Rr=Lr);var jr=3;Ne&&(jr/=Ne);var qr=jr;if(l.carbs){jr=Math.max(jr,l.mealCOB/20);var Wr=o((new Date(Ge).getTime()-l.lastCarbTime)/6e4),Hr=(l.carbs-l.mealCOB)/l.carbs;qr=o(qr=jr+1.5*Wr/60,1),console.error("Last carbs "+Wr+" minutes ago; remainingCATime:"+qr+"hours; "+o(100*Hr)+"% carbs absorbed")}var Nr=Math.max(0,Rr/5*60*qr/2)/csf,Xr=90,Yr=1;i.remainingCarbsCap&&(Xr=Math.min(90,i.remainingCarbsCap)),i.remainingCarbsFraction&&(Yr=Math.min(1,i.remainingCarbsFraction));var Vr=1-Yr,Zr=Math.max(0,l.mealCOB-Nr-l.carbs*Vr),$r=(Zr=Math.min(Xr,Zr))*csf*5/60/(qr/2),Jr=o(l.slopeFromMaxDeviation,2),Kr=o(l.slopeFromMinDeviation,2),Qr=Math.min(Jr,-Kr/3),ea=0;0===Rr?Er=0:!0===i.floating_carbs?(Er=Math.min(60*qr/5/2,Math.max(0,l.carbs*csf/Rr)),ea=Math.min(60*qr/5/2,Math.max(0,l.mealCOB*csf/Rr)),l.carbs>0&&(oe+=", Floating Carbs:, CID: "+o(Er,1)+", MealCarbs: "+o(l.carbs,1)+", Not Floating:, CID: "+o(ea,1)+", MealCOB: "+o(l.mealCOB,1),console.error("Floating Carbs CID: "+o(Er,1)+" / MealCarbs: "+o(l.carbs,1)+" vs. Not Floating:"+o(ea,1)+" / MealCOB:"+o(l.mealCOB,1)))):Er=Math.min(60*qr/5/2,Math.max(0,l.mealCOB*csf/Rr)),console.error("Carb Impact:"+Rr+"mg/dL per 5m; CI Duration:"+o(5*Er/60*2,1)+"hours; remaining CI ("+o(qr/2,2)+"h peak):",o($r,1)+"mg/dL per 5m");var ra,aa,ta,oa,na,ia=999,sa=999,la=999,da=Pe,ua=999,ma=999,ca=999,_a=999,pa=Cr,fa=Pe,ba=Pe,ga=0,ha=[],Ba=[];try{Sr.forEach((function(e){var r=o(-e.activity*sr*5,2),a=o(-e.iobWithZeroTemp.activity*sr*5,2),t=Rr*(1-Math.min(1,Ur.length/12));pa=Ur[Ur.length-1]+r+t;var n=zr[zr.length-1]+a,i=Math.max(0,Math.max(0,Rr)*(1-Gr.length/Math.max(2*Er,1))),s=Math.min(Gr.length,12*qr-Gr.length),l=Math.max(0,s/(qr/2*12)*$r);i+l,ha.push(o(l,0)),Ba.push(o(i,0)),COBpredBG=Gr[Gr.length-1]+r+Math.min(0,t)+i+l;var d=Math.max(0,kr+Ar.length*Qr),u=Math.max(0,kr*(1-Ar.length/Math.max(36,1))),m=Math.min(d,u);m>0&&(ga=o(5*(Ar.length+1)/60,1)),UAMpredBG=Ar[Ar.length-1]+r+Math.min(0,t)+m,Ur.length<48&&Ur.push(pa),Gr.length<48&&Gr.push(COBpredBG),Ar.length<48&&Ar.push(UAMpredBG),zr.length<48&&zr.push(n),COBpredBG<ua&&(ua=o(COBpredBG)),UAMpredBG<ma&&(ma=o(UAMpredBG)),pa<ca&&(ca=o(pa)),n<_a&&(_a=o(n));Ur.length>18&&pa<ia&&(ia=o(pa)),pa>fa&&(fa=pa),(Er||$r>0)&&Gr.length>18&&COBpredBG<sa&&(sa=o(COBpredBG)),(Er||$r>0)&&COBpredBG>fa&&(ba=COBpredBG),Pr&&Ar.length>12&&UAMpredBG<la&&(la=o(UAMpredBG)),Pr&&UAMpredBG>fa&&UAMpredBG}))}catch(e){console.error("Problem with iobArray.  Optional feature Advanced Meal Assist disabled")}we.predBGs={},Ur.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))}));for(var va=Ur.length-1;va>12&&Ur[va-1]===Ur[va];va--)Ur.pop();for(we.predBGs.IOB=Ur,ta=o(Ur[Ur.length-1]),zr.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),va=zr.length-1;va>6&&!(zr[va-1]>=zr[va]||zr[va]<=je);va--)zr.pop();if(we.predBGs.ZT=zr,o(zr[zr.length-1]),l.mealCOB>0&&(Rr>0||$r>0)){for(Gr.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),va=Gr.length-1;va>12&&Gr[va-1]===Gr[va];va--)Gr.pop();we.predBGs.COB=Gr,oa=o(Gr[Gr.length-1]),Cr=Math.max(Cr,o(Gr[Gr.length-1]))}if(Rr>0||$r>0){if(Pr){for(Ar.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),va=Ar.length-1;va>12&&Ar[va-1]===Ar[va];va--)Ar.pop();we.predBGs.UAM=Ar,na=o(Ar[Ar.length-1]),Ar[Ar.length-1]&&(Cr=Math.max(Cr,o(Ar[Ar.length-1])))}we.eventualBG=Cr}console.error("UAM Impact:"+kr+"mg/dL per 5m; UAM Duration:"+ga+"hours"),ia=Math.max(39,ia),sa=Math.max(39,sa),la=Math.max(39,la),ra=o(ia);var Ma=l.mealCOB/l.carbs;aa=o(la<999&&sa<999?(1-Ma)*UAMpredBG+Ma*COBpredBG:sa<999?(pa+COBpredBG)/2:la<999?(pa+UAMpredBG)/2:pa),_a>aa&&(aa=_a),da=o(da=Er||$r>0?Pr?Ma*ua+(1-Ma)*ma:ua:Pr?ma:ca);var xa=la;if(_a<nr)xa=(la+_a)/2;else if(_a<je){var ya=(_a-nr)/(je-nr);xa=(la+(la*ya+_a*(1-ya)))/2}else _a>la&&(xa=(la+_a)/2);if(xa=o(xa),l.carbs)if(!Pr&&sa<999)ra=o(Math.max(ia,sa));else if(sa<999){var Sa=Ma*sa+(1-Ma)*xa;ra=o(Math.max(ia,sa,Sa))}else ra=Pr?xa:da;else Pr&&(ra=o(Math.max(ia,xa)));ra=Math.min(ra,aa),process.stderr.write("minPredBG: "+n(ra,i)+" minIOBPredBG: "+n(ia,i)+" minZTGuardBG: "+n(_a,i)),sa<999&&process.stderr.write(" minCOBPredBG: "+n(sa,i)),la<999&&process.stderr.write(" minUAMPredBG: "+n(la,i)),console.error(" avgPredBG:"+n(aa,i)+" COB/Carbs:"+l.mealCOB+"/"+l.carbs),ba>Pe&&(ra=Math.min(ra,ba)),we.COB=l.mealCOB,we.IOB=a.iob,we.BGI=n(Fr,i),we.deviation=n(Tr,i),we.dura_ISFratio=o(xe,2),we.bg_ISFratio=o(Be,2),we.delta_ISFratio=o(ve,2),we.pp_ISFratio=o(Me,2),we.acce_ISFratio=o(ge,2),we.auto_ISFratio=o(re(i)/sr,2),we.ISF=n(sr,i),we.CR=o(i.carb_ratio,2),we.TDD=o(ee,1),we.TDDytd=o(C,1),we.TDD7d=o(O,1),we.target_bg=n(je,i),we.minDelta=Ee,we.expectedDelta=Or,we.minGuardBG=da,we.minPredBG=ra;var Ia=function(e,r,a,t){var n=e.smb_delivery_ratio_bg_range;n<10&&(n/=.0555);var i=e.smb_delivery_ratio,s=Math.min(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max),l=Math.max(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max),d=a+n,u=i;return n>0&&(u=s+(l-s)*(r-a)/n,u=Math.max(s,Math.min(l,u))),"fullLoop"==t?(console.error("MB delivery ratio set to "+o(Math.max(i,u),2)+" as max of fixed and interpolated values"),Math.max(i,u)):0==n?(console.error("MB delivery ratio set to fixed value "+o(i,2)),i):r<=a?(console.error("MB delivery ratio limited by minimum value "+o(s,2)),s):r>=d?(console.error("MB delivery ratio limited by maximum value "+o(l,2)),l):(console.error("MB delivery ratio set to interpolated value "+o(u,2)),u)}(i,Pe,je,Mr);we.SMBratio=o(Ia,2);o(Ia,2);let wa="";""!==g&&"Nothing changed"!==g&&(wa="Middleware:, "+g+", ");let Fa="";i.use_autosens_isf_to_calculate_auto_isf_sens&&(Fa="Basal: "+o(i.current_basal,2)+"→"+o(ae(i),2)+" (tddISF: "+n(1700/i.calculate_isf_from_tdd_numerator_divisor/I,i)+"), Autosens ratio: "+o(s.ratio,2)+", ");let Ta="";i.enable_max_iob_deadbands&&(Ta="maxIOB: "+o(te(i,e,je),2)+" ("+function(e,r,a){const t=r.glucose;if(e.enable_max_iob_deadbands){const r=e.tight_deadband_range/100*a+a,o=e.loose_deadband_range/100*a+a;if(t>=0&&t<r&&!e.moderate_carb_ez_fcl_profile&&!e.high_carb_ez_fcl_profile)return e.max_iob_tight_deadband;if(t>=r&&t<=o&&!e.moderate_carb_ez_fcl_profile&&!e.high_carb_ez_fcl_profile)return e.max_iob_loose_deadband;if(t>=0&&e.sleep_mode)return e.max_iob_tight_deadband;if(t>=0&&e.automatic_sleep_mode)return e.max_iob_tight_deadband}return e.max_iob}(i,e,je)+"% of TDD)");let Da="";i.enable_max_iob_deadbands&&(Da="tddISF-AF: "+o(i.calculate_isf_from_tdd_numerator_divisor,2)+", "),we.reason=wa+Da+Fa+Ta+fe+be+pe+oe+", Standard, BGI: "+we.BGI+", Target: "+we.target_bg+", minPredBG "+n(ra,i)+", minGuardBG "+n(da,i)+", IOBpredBG "+n(ta,i),oa>0&&(we.reason+=", COBpredBG "+n(oa,i)),na>0&&(we.reason+=", UAMpredBG "+n(na,i)),we.reason+=tddReason,we.reason+="; ";var Ca=Dr;Ca<40&&(Ca=Math.min(da,Ca));var Oa,Ga=nr-Ca,Ua=240,Aa=240;if(l.mealCOB>0&&(Rr>0||$r>0)){for(va=0;va<Gr.length;va++)if(Gr[va]<qe){Ua=5*va;break}for(va=0;va<Gr.length;va++)if(Gr[va]<nr){Aa=5*va;break}}else{for(va=0;va<Ur.length;va++)if(Ur[va]<qe){Ua=5*va;break}for(va=0;va<Ur.length;va++)if(Ur[va]<nr){Aa=5*va;break}}xr&&da<nr&&(console.error("minGuardBG "+n(da,i)+" projected below "+n(nr,i)+" - disabling MB"),Te=1,Fe=o((Cr-je)/sr,2),xr=!1),void 0===i.maxDelta_bg_threshold&&(Oa=.2),void 0!==i.maxDelta_bg_threshold&&(Oa=Math.min(i.maxDelta_bg_threshold,.4)),Le>Oa*Pe&&(console.error("maxDelta "+n(Le,i)+" > "+100*Oa+"% of BG "+n(Pe,i)+" - disabling MB"),we.reason+="maxDelta "+n(Le,i)+" > "+100*Oa+"% of BG "+n(Pe,i)+" - MB disabled!, ",xr=!1),console.error("BG projected to remain above "+n(qe,i)+" for "+Ua+"minutes"),(Aa<240||Ua<60)&&console.error("BG projected to remain above "+n(nr,i)+" for "+Aa+"minutes");var za=Aa,Pa=ae(i)*sr*za/60,Ra=Math.max(0,l.mealCOB-.25*l.carbs),Ea=(Ga-Pa)/csf-Ra;if(Pa=o(Pa),Ea=o(Ea),console.error("naive_eventualBG: "+n(Dr,i)+", bgUndershoot: "+n(Ga,i)+", zeroTempDuration: "+za+", zeroTempEffect: "+Pa+", carbsReq: "+Ea),"Could not parse clock data"==l.reason?console.error("carbsReq unknown: Could not parse clock data"):Ea>=i.carbsReqThreshold&&Aa<=45&&(we.carbsReq=Ea,we.reason+=Ea+" add'l carbs req w/in "+Aa+"m; "),dr&&cr<=mr)return we.reason+="setting AIMI B30 Temp "+t(ur,i)+"U/hr for "+(mr-cr)+"m ",we.temp="absolute",we.deliverAt=De,we.duration=Math.min(30,mr-cr),console.error("Forcing AIMI temp "+ur+"U/hr"),d.setTempBasal(ur,30,i,we,r);var ka=0;if(Pe<nr&&a.iob<20*-ae(i)/60&&Ee>0&&Ee>Or)we.reason+="IOB "+a.iob+" < "+o(20*-ae(i)/60,2),we.reason+=" and minDelta "+n(Ee,i)+" > expectedDelta "+n(Or,i)+"; ";else if(Pe<nr||da<nr)return we.reason+="minGuardBG "+n(da,i)+"<"+n(nr,i),da<nr&&(Te=2),Fe=o((Cr-je)/sr,2),ka=o(60*((Ga=je-da)/sr)/ae(i)),ka=30*o(ka/30),ka=Math.min(120,Math.max(30,ka)),d.setTempBasal(0,ka,i,we,r);if(i.skip_neutral_temps&&we.deliverAt.getMinutes()>=55){if(!xr)return we.reason+="; Canceling temp at "+(60-we.deliverAt.getMinutes())+"min before turn of the hour to avoid beeping of MDT. MB disabled anyways.",d.setTempBasal(0,0,i,we,r);console.error(60-we.deliverAt.getMinutes()+"min before turn of the hour, but MB's are enabled - no skipping neutral temps")}var La=0,ja=Oe;if(Cr<qe){if(we.reason+="Eventual BG "+n(Cr,i)+" < "+n(qe,i),Ee>Or&&Ee>0&&!Ea)return Dr<40?(we.reason+=", naive_eventualBG < 40. ",d.setTempBasal(0,30,i,we,r)):(e.delta>Ee?we.reason+=", but Delta "+n(Ue,i)+" > expectedDelta "+n(Or,i):we.reason+=", but Min. Delta "+Ee.toFixed(2)+" > Exp. Delta "+n(Or,i),r.duration>15&&t(Oe,i)===t(r.rate,i)?(we.reason+=", temp "+r.rate+" ~ req "+o(Oe,2)+"U/hr. ",we):(we.reason+="; setting current basal of "+o(Oe,2)+" as temp. ",d.setTempBasal(Oe,30,i,we,r)));La=o(La=2*Math.min(0,(Cr-je)/sr),2);var qa=Math.min(0,(Dr-je)/sr);if(qa=o(qa,2),Ee<0&&Ee>Or)La=o(La*(Ee/Or),2);if(ja=t(ja=Oe+2*La,i),r.duration*(r.rate-Oe)/60<Math.min(La,qa)-.3*Oe)return we.reason+=", "+r.duration+"m@"+r.rate.toFixed(2)+" is a lot less than needed. ",d.setTempBasal(ja,30,i,we,r);if(void 0!==r.rate&&r.duration>5&&ja>=.8*r.rate)return we.reason+=", temp "+r.rate+" ~< req "+o(ja,2)+"U/hr. ",we;if(ja<=0){if((ka=o(60*((Ga=je-Dr)/sr)/ae(i)))<0?ka=0:(ka=30*o(ka/30),ka=Math.min(120,Math.max(0,ka))),ka>0)return we.reason+=", setting "+ka+"m zero temp. ",d.setTempBasal(ja,ka,i,we,r)}else we.reason+=", setting "+o(ja,2)+"U/hr. ";return d.setTempBasal(ja,30,i,we,r)}if(Ee<Or&&(we.minDelta=Ee,we.expectedDelta=Or,(Or-Ee>=2||Or+-1*Ee>=2)&&(Te=Ee>=0&&Or>0?3:Ee<0&&Or<=0||Ee<0&&Or>=0?4:5),Fe=o((Cr-je)/sr,2),!u||!xr))return e.delta<Ee?we.reason+="Eventual BG "+n(Cr,i)+" > "+n(qe,i)+" but Delta "+n(Ue,i)+" < Exp. Delta "+n(Or,i):we.reason+="Eventual BG "+n(Cr,i)+" > "+n(qe,i)+" but Min. Delta "+Ee.toFixed(2)+" < Exp. Delta "+n(Or,i),r.duration>15&&t(Oe,i)===t(r.rate,i)?(we.reason+=", temp "+r.rate+" ~ req "+Oe+"U/hr. ",we):(we.reason+="; setting current basal of "+Oe+" as temp. ",d.setTempBasal(Oe,30,i,we,r));if(Math.min(Cr,ra)<We&&(ra<qe&&Cr>qe&&(Te=6,Fe=o((Cr-je)/sr,2)),!u||!xr))return we.reason+=n(Cr,i)+"-"+n(ra,i)+" in range: no temp required",r.duration>15&&t(Oe,i)===t(r.rate,i)?(we.reason+=", temp "+r.rate+" ~ req "+Oe+"U/hr. ",we):(we.reason+="; setting current basal of "+Oe+" as temp. ",d.setTempBasal(Oe,30,i,we,r));if(Cr>=We&&(we.reason+="Eventual BG "+n(Cr,i)+" >= "+n(We,i)+", "),a.iob>te(i,e,je))return we.reason+="IOB "+o(a.iob,2)+" > maxIOB "+o(te(i,e,je),2),r.duration>15&&t(Oe,i)===t(r.rate,i)?(we.reason+=", temp "+r.rate+" ~ req "+Oe+"U/hr. ",we):(we.reason+="; setting current basal of "+Oe+" as temp. ",d.setTempBasal(Oe,30,i,we,r));La=o((Math.min(ra,Cr)-je)/sr,2),Fe=o((Cr-je)/sr,2),La>te(i,e,je)-a.iob?(we.reason+="maxIOB "+o(te(i,e,je),2)+", ",console.error("InsReq "+o(La,2)+" capped at "+o(te(i,e,je)-a.iob,2)+" to not exceed maxIOB"),La=te(i,e,je)-a.iob):console.error("MB not limited by maxIOB (insulinReq: "+La+" U)"),Fe>te(i,e,je)-a.iob?console.error("Ev. Bolus limited by maxIOB to "+o(te(i,e,je)-a.iob,2)+" (insulinForManualBolus: "+Fe+" U)"):console.error("Ev. Bolus would not be limited by maxIOB (insulinForManualBolus: "+Fe+" U)."),ja=t(ja=Oe+2*La,i),La=o(La,3),we.insulinReq=La,we.insulinForManualBolus=o(Fe,2),we.manualBolusErrorString=Te,we.minDelta=Ee,we.expectedDelta=Or,we.minGuardBG=da,we.minPredBG=ra,we.threshold=n(nr,i),we.reason="Ins.Req: "+o(La,2)+", "+we.reason;var Wa=o((new Date(Ge).getTime()-a.lastBolusTime)/6e4,1);if(u&&xr&&Pe>nr){var Ha=o(l.mealCOB/i.carb_ratio,3);if(i.use_autoisf)Na=i.smb_max_range_extension;else{console.error("ezFCL disabled, MB range extension disabled");var Na=1}Na>1&&console.error("MB max range extended from default by factor "+Na);var Xa=0;void 0===i.maxSMBBasalMinutes?(Xa=o(Na*ae(i)*30/60,1),console.error("profile.maxSMBBasalMinutes undefined: defaulting to 30m")):a.iob>Ha&&a.iob>0?(console.error("IOB "+a.iob+" > COB "+l.mealCOB+"; mealInsulinReq = "+Ha),i.maxUAMSMBBasalMinutes?(console.error("profile.maxUAMSMBBasalMinutes:",i.maxUAMSMBBasalMinutes,"getBasalValue(profile):",ae(i)),Xa=o(Na*ae(i)*i.maxUAMSMBBasalMinutes/60,1)):(console.error("profile.maxUAMSMBBasalMinutes undefined: defaulting to 30m"),Xa=o(30*ae(i)/60,1))):(console.error("profile.maxSMBBasalMinutes:",i.maxSMBBasalMinutes,"getBasalValue(profile):",ae(i)),Xa=o(Na*ae(i)*i.maxSMBBasalMinutes/60,1));var Ya=i.bolus_increment,Va=1/Ya;Ia>.5&&console.error("MB Delivery Ratio increased from default 0.5 to "+o(Ia,2));var Za=Math.min(La*Ia,Xa),$a="",Ja=ye/100*130/100*te(i,e,je)*Ke;Za>Ja-a.iob&&("fullLoop"==Mr||"enforced"==Mr)&&(Za=Ja-a.iob,$a=", capped by autoISF iobTH",console.error("ezFCL capped MB at "+o(Za,2)+" to not exceed 130% of effective iobTH "+o(Ja/130*100,2)+"U")),Za=Math.floor(Za*Va)/Va,ka=o(60*((je-(Dr+ia)/2)/sr)/ae(i)),La>0&&Za<Ya&&(ka=0);var Ka=0;ka<=0?ka=0:ka>=30?(ka=30*o(ka/30),ka=Math.min(60,Math.max(0,ka))):(Ka=o(Oe*ka/30,2),ka=30),we.reason+=" insulinReq "+La,Za>=Xa&&(we.reason+="; maxBolus "+Xa),ka>0&&(we.reason+="; setting "+ka+"m low temp of "+Ka+"U/h"),we.reason+=". ";var Qa=3;i.SMBInterval&&(Qa=Math.min(10,Math.max(1,i.SMBInterval)));var et=o(Qa-Wa,0),rt=o(60*(Qa-Wa),0)%60;if(console.error("naive_eventualBG "+n(Dr,i)+", "+ka+"m "+Ka+"U/h temp needed; last bolus "+Wa+"m ago; maxBolus: "+Xa),Wa>Qa?Za>0&&(we.units=Za,we.reason+="Microbolusing "+Za+"U"+$a+". "):we.reason+="Waiting "+et+"m "+rt+"s to microbolus again. ",ka>0)return we.rate=Ka,we.duration=ka,we}var at=ae(i)/i.current_basal*d.getMaxSafeBasal(i);return ja>at&&(we.reason+="adj. req. rate: "+o(ja,2)+" to maxSafeBasal: "+o(at,2)+", ",ja=t(at,i)),r.duration*(r.rate-Oe)/60>=2*La?(we.reason+=r.duration+"m@"+r.rate.toFixed(2)+" > 2 * insulinReq. Setting temp basal of "+ja+"U/hr. ",d.setTempBasal(ja,30,i,we,r)):void 0===r.duration||0===r.duration?(we.reason+="no temp, setting "+ja+"U/hr. ",d.setTempBasal(ja,30,i,we,r)):r.duration>5&&t(ja,i)<=t(r.rate,i)?(we.reason+="temp "+r.rate+" >~ req "+ja+"U/hr. ",we):(we.reason+="temp "+r.rate+"<"+ja+"U/hr. ",d.setTempBasal(ja,30,i,we,r))}},3531:(e,r,a)=>{var t=a(2296);e.exports=function(e,r){var a=20;void 0!==r&&"string"==typeof r.model&&(t(r.model,"54")||t(r.model,"23"))&&(a=40);return e<1?Math.round(e*a)/a:e<10?Math.round(20*e)/20:Math.round(10*e)/10}},1873:(e,r,a)=>{var t=a(9325).Symbol;e.exports=t},4932:e=>{e.exports=function(e,r){for(var a=-1,t=null==e?0:e.length,o=Array(t);++a<t;)o[a]=r(e[a],a,e);return o}},7133:e=>{e.exports=function(e,r,a){return e==e&&(void 0!==a&&(e=e<=a?e:a),void 0!==r&&(e=e>=r?e:r)),e}},2552:(e,r,a)=>{var t=a(1873),o=a(659),n=a(9350),i=t?t.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":i&&i in Object(e)?o(e):n(e)}},7556:(e,r,a)=>{var t=a(1873),o=a(4932),n=a(6449),i=a(4394),s=t?t.prototype:void 0,l=s?s.toString:void 0;e.exports=function e(r){if("string"==typeof r)return r;if(n(r))return o(r,e)+"";if(i(r))return l?l.call(r):"";var a=r+"";return"0"==a&&1/r==-1/0?"-0":a}},4128:(e,r,a)=>{var t=a(1800),o=/^\s+/;e.exports=function(e){return e?e.slice(0,t(e)+1).replace(o,""):e}},4840:(e,r,a)=>{var t="object"==typeof a.g&&a.g&&a.g.Object===Object&&a.g;e.exports=t},659:(e,r,a)=>{var t=a(1873),o=Object.prototype,n=o.hasOwnProperty,i=o.toString,s=t?t.toStringTag:void 0;e.exports=function(e){var r=n.call(e,s),a=e[s];try{e[s]=void 0;var t=!0}catch(e){}var o=i.call(e);return t&&(r?e[s]=a:delete e[s]),o}},9350:e=>{var r=Object.prototype.toString;e.exports=function(e){return r.call(e)}},9325:(e,r,a)=>{var t=a(4840),o="object"==typeof self&&self&&self.Object===Object&&self,n=t||o||Function("return this")();e.exports=n},1800:e=>{var r=/\s/;e.exports=function(e){for(var a=e.length;a--&&r.test(e.charAt(a)););return a}},2296:(e,r,a)=>{var t=a(7133),o=a(7556),n=a(1489),i=a(3222);e.exports=function(e,r,a){e=i(e),r=o(r);var s=e.length,l=a=void 0===a?s:t(n(a),0,s);return(a-=r.length)>=0&&e.slice(a,l)==r}},6449:e=>{var r=Array.isArray;e.exports=r},3805:e=>{e.exports=function(e){var r=typeof e;return null!=e&&("object"==r||"function"==r)}},346:e=>{e.exports=function(e){return null!=e&&"object"==typeof e}},4394:(e,r,a)=>{var t=a(2552),o=a(346);e.exports=function(e){return"symbol"==typeof e||o(e)&&"[object Symbol]"==t(e)}},7400:(e,r,a)=>{var t=a(6993),o=1/0;e.exports=function(e){return e?(e=t(e))===o||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}},1489:(e,r,a)=>{var t=a(7400);e.exports=function(e){var r=t(e),a=r%1;return r==r?a?r-a:r:0}},6993:(e,r,a)=>{var t=a(4128),o=a(3805),n=a(4394),i=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,l=/^0o[0-7]+$/i,d=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(n(e))return NaN;if(o(e)){var r="function"==typeof e.valueOf?e.valueOf():e;e=o(r)?r+"":r}if("string"!=typeof e)return 0===e?e:+e;e=t(e);var a=s.test(e);return a||l.test(e)?d(e.slice(2),a?2:8):i.test(e)?NaN:+e}},3222:(e,r,a)=>{var t=a(7556);e.exports=function(e){return null==e?"":t(e)}}},r={};function a(t){var o=r[t];if(void 0!==o)return o.exports;var n=r[t]={exports:{}};return e[t](n,n.exports,a),n.exports}a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}();var t=a(2982);freeaps_determineBasal=t})();
