var freeaps_determineBasal;(()=>{var e={2982:(e,r,a)=>{var t=a(3531);function o(e,r){r||(r=0);var a=Math.pow(10,r);return Math.round(e*a)/a}function n(e,r){return"mmol/L"===r.out_units?o(.0555*e,1):Math.round(e)}function i(e,r){return e.adjust_basal_inversely_to_autosens_isf&&r&&r.ratio?e.sens/r.ratio:e.sens}function s(e,r){const a=e.current_basal,t=e.sens;if(e.adjust_basal_inversely_to_autosens_isf&&r&&r.newisf){let e=a*(t/r.newisf);return e=Math.max(0,.05*Math.round(e/.05)),e}return a}var l="",u="",m="",d="",c="",p="",b="",f="",g="",h="",B="",_="",v="",M=1,S=1,x=1,y=1,I=1,w=1,F=100;function T(e,r,a,t,i){if(void 0===a)return rT.error="Error: iob_data undefined. ",rT;var s=a;if(a.length,a.length>1&&(a=s[0]),void 0===a.activity||void 0===a.iob)return rT.error="Error: iob_data missing some property. ",rT;if(!t)return u=", autoISF-SMB disabled:, B30 running","AIMI B30";if(!e)return"oref";var l=n(r.min_bg,r);if(r.use_autoisf&&r.temptargetSet&&r.enableSMB_EvenOn_OddOff||r.use_autoisf&&r.min_bg==r.max_bg&&r.enableSMB_EvenOn_OddOff_always&&!r.temptargetSet){r.temptargetSet?msgType="TempTarget ":msgType="ProfileTarget ","mmol/L"==r.out_units?(evenTarget=o(10*l,0)%2==0,msgUnits=" has ",msgTail=" decimal"):(evenTarget=l%2==0,msgUnits=" is ",msgTail=" number"),evenTarget?msgEven="even":msgEven="odd",r.iob_threshold_percent<100&&r.iob_threshold_percent>0&&(F=r.iob_threshold_percent);var m=F;return evenTarget?0==r.max_iob?(console.error("SMB disabled because of maxIOB=0"),"blocked"):m/100<a.iob/(r.max_iob*i)?(console.error("iobTH: "+o(m,1)+"%, IOB% of maxIOB at "+o(a.iob/(r.max_iob*i)*100,1)+"%"),1!=i?(console.error("Full Loop modified maxIOB "+r.max_iob+" to effectively "+o(r.max_iob*i,2)+" due to profile % and/or exercise mode"),", effective maxIOB "+o(r.max_iob*i,2)):", maxIOB "+r.max_iob,u=", autoISF-SMB disabled:, iobTH exceeded",console.error("SMB disabled by Full Loop logic: IOB "+a.iob+" is more than "+m+"% of maxIOB "+r.max_iob),console.error("Full Loop capped"),"iobTH"):(console.error("SMB enabled - "+msgType+l+msgUnits+msgEven+msgTail),l<100?(console.error("iobTH: "+o(m,1)+"%, IOB% of maxIOB at "+o(a.iob/(r.max_iob*i)*100,1)+"%"),console.error("Loop at full power"),u=", autoISF-SMB enabled:, even TT","fullLoop"):(console.error("iobTH: "+o(m,1)+"%, IOB% of maxIOB at "+o(a.iob/(r.max_iob*i)*100,1)+"%"),u=", autoISF-SMB enabled:, even Target",console.error("Loop at medium power"),"enforced")):(console.error("SMB disabled - "+msgType+l+msgUnits+msgEven+msgTail),u=", autoISF-SMB disabled:, odd Target",console.error("Loop at minimum power"),"blocked")}return console.error("Full Loop disabled"),"oref"}function D(e,r,a){"bg"==a?(polyX=[50,60,80,90,100,110,150,180,200],polyY=[-.5,-.5,-.3,-.2,0,0,.5,.7,.7]):"delta"==a&&(polyX=[2,7,12,16,20],polyY=[0,0,.4,.7,.7]);var t=polyX.length-1,o=polyX[0],n=polyY[0],i=polyX[t],s=polyY[t],l=1,u=1,m=1,d=o;if(o>e)i=polyX[1],l=(u=n)+((s=polyY[1])-u)/(i-(m=o))*(e-m);else if(i<e)o=polyX[t-1],l=(u=n=polyY[t-1])+(s-u)/(i-(m=o))*(e-m);else for(var c=0;c<=t;c++){if(o=polyX[c],n=polyY[c],o==e){l=n;break}if(o>e){l=u+(n-u)/(o-(m=d))*(e-m);break}u=n,d=o}return l*="delta"==a?r.delta_ISFrange_weight:e>100?r.higher_ISFrange_weight:r.lower_ISFrange_weight}function O(e,r,a,t,n,i,s,l,u){console.error("check ratio "+o(e,2)+" against autoISF min: "+r+" and autoISF max: "+a),e<r?(g=" (lmtd.min)",b="weakest autoISF factor "+o(e,2)+" limited by autoISF_min "+r,console.error(b),e=r):e>a&&(g=" (lmtd.max)",b="strongest autoISF factor "+o(e,2)+" limited by autoISF_max "+a,console.error(b),e=a);var m=1;return s&&i.temptargetSet&&l>u?(m=e*t,n=" (exerciseMode)",console.error("autoISF adjusts sens "+t+", instead of profile.sens "+i.sens),h=n):e>=1?(m=Math.max(e,t),e>=t&&(n="")):(m=Math.min(e,t),e<=t&&(n="")),b="final ISF factor "+o(m,2)+n,console.error(b),m}e.exports=function(e,r,a,C,G,U,A,R,P,E,j,k,q,L,W){var z=0,H="",N="",X="",Y="",Z="",$=0,V=0,J=0,K=0,Q=0,ee=0;const re=L.tddYtd,ae=L.tdd7d,te=L.hbt,oe=L.isEnabled,ne=e.avgdelta;function ie(e,r){var a=e.getTime();return new Date(a+36e5*r)}function se(e){var r=C.bolus_increment;.025!=r&&(r=.05);var a=e/r;return a>=1?o(Math.floor(a)*r,5):0}function le(e){function r(e){return e<10&&(e="0"+e),e}return r(e.getHours())+":"+r(e.getMinutes())+":00"}function ue(e,r){var a=new Date("1/1/1999 "+e),t=new Date("1/1/1999 "+r);return(a.getTime()-t.getTime())/36e5}function me(e,r){var a=0,t=r,o=(e-r)/36e5,n=0,i=o,s=0;do{if(o>0){var l=le(t);q[0].rate;for(let e=0;e<q.length;e++){var u=q[e].start;if(l==u){if(e+1<q.length){o>=(s=ue(q[e+1].start,q[e].start))?n=s:o<s&&(n=o)}else if(e+1==q.length){let r=q[0].start;o>=(s=24-ue(q[e].start,r))?n=s:o<s&&(n=o)}a+=se(q[e].rate*n),o-=n,t=ie(t,n)}else if(l>u)if(e+1<q.length){var m=q[e+1].start;l<m&&(o>=(s=ue(m,l))?n=s:o<s&&(n=o),a+=se(q[e].rate*n),o-=n,t=ie(t,n))}else if(e==q.length-1){o>=(s=ue("23:59:59",l))?n=s:o<s&&(n=o),a+=se(q[e].rate*n),o-=n,t=ie(t,n)}}}}while(o>0&&o<i);return a}if(j.length){let e=j.length-1;var de=new Date(j[e].timestamp),ce=new Date(j[0].timestamp);if("TempBasalDuration"==j[0]._type&&(ce=new Date),(z=(ce-de)/36e5)<23.9&&z>21)Q=me(de,(pe=24-z,be=de.getTime(),new Date(be-36e5*pe))),Y="24 hours of data is required for an accurate tdd calculation. Currently only "+z.toPrecision(3)+" hours of pump history data are available. Using your pump scheduled basals to fill in the missing hours. Scheduled basals added: "+Q.toPrecision(5)+" U. ";else Y=""}else console.log("Pumphistory is empty!"),dynISFenabled=!1,enableDynamicCR=!1;var pe,be,fe=0,ge=0;o((new Date(Ge).getTime()-U.lastBolusNormalTime)/6e4,1);for(let e=0;e<j.length;e++)if("Bolus"==j[e]._type&&(K+=j[e].amount,0==fe&&j[e].amount>=C.iTime_Start_Bolus)){fe=t(j[e].amount,C);var he=new Date(j[e].timestamp);ge=o((new Date-he)/36e5*60)}for(let e=1;e<j.length;e++)if("TempBasal"==j[e]._type&&j[e].rate>0){$=e,ee=j[e].rate;var Be=j[e-1]["duration (min)"]/60,_e=Be,ve=new Date(j[e-1].timestamp),Me=ve;do{if(e--,0==e){Me=new Date;break}if("TempBasal"==j[e]._type||"PumpSuspend"==j[e]._type){Me=new Date(j[e].timestamp);break}}while(e>0);var Se=(Me-ve)/36e5;Se<_e&&(Be=Se),J+=se(ee*Be),e=$}for(let e=0;e<j.length;e++)if(0,0==j[e]["duration (min)"]||"PumpResume"==j[e]._type){let r=new Date(j[e].timestamp),a=r,t=e;do{if(t>0&&(--t,"TempBasal"==j[t]._type)){a=new Date(j[t].timestamp);break}}while(t>0);(a-r)/36e5>0&&(Q+=me(a,r))}for(let e=j.length-1;e>0;e--)if("TempBasalDuration"==j[e]._type){let r=j[e]["duration (min)"]/60,a=new Date(j[e].timestamp);var xe=a;let t=e;do{if(--t,t>=0&&("TempBasal"==j[t]._type||"PumpSuspend"==j[t]._type)){xe=new Date(j[t].timestamp);break}}while(t>0);if(0==e&&"TempBasalDuration"==j[0]._type&&(xe=new Date,r=j[e]["duration (min)"]/60),(xe-a)/36e5-r>0){Q+=me(xe,ie(a,r))}}var ye={TDD:o(V=K+J+Q,5),bolus:o(K,5),temp_basal:o(J,5),scheduled_basal:o(Q,5)},Ie=V;z>21?(N=". Bolus insulin: "+K.toPrecision(5)+" U",X=". Temporary basal insulin: "+J.toPrecision(5)+" U",H=". Insulin with scheduled basal rate: "+Q.toPrecision(5)+" U",Z=Y+(" TDD past 24h is: "+V.toPrecision(5)+" U")+N+X+H,tddReason=", TDD, 24h: "+o(V,1)+", ytd: "+o(re,1)+", 7dØ: "+o(ae,1),console.error(Z)):tddReason=", TDD: Not enough pumpData (< 21h)";var we={},Fe=0,Te=0,De=new Date;if(E&&(De=new Date(E)),void 0===C||void 0===s(C,G))return we.error="Error: could not get current basal rate",we;var Oe=t(s(C,G),C),Ce=Oe,Ge=new Date;E&&(Ge=new Date(E));var Ue,Ae=new Date(e.date),Re=o((Ge-Ae)/60/1e3,1),Pe=e.glucose,Ee=e.noise;Ue=n(e.delta,C);var je=Math.min(e.delta,e.short_avgdelta),ke=Math.min(e.short_avgdelta,e.long_avgdelta),qe=Math.max(e.delta,e.short_avgdelta,e.long_avgdelta);(Pe<=10||38===Pe||Ee>=3)&&(we.reason="CGM is calibrating, in ??? state, or noise is high");if(Re>12||Re<-5?we.reason="If current system time "+Ge+" is correct, then BG data is too old. The last BG data was read "+Re+"m ago at "+Ae:Pe>60&&e.cgmFlatMinutes>89&&e.last_cal&&e.last_cal<3&&(we.reason="CGM was just calibrated"),Pe<=10||38===Pe||Ee>=3||Re>12||Re<-5||Pe>60&&e.cgmFlatMinutes>89||0===e.short_avgdelta&&0===e.long_avgdelta)return r.rate>Ce?(we.reason+=". Replacing high temp basal of "+r.rate+" with neutral temp of "+Ce,we.deliverAt=De,we.temp="absolute",we.duration=30,we.rate=Ce,we):0===r.rate&&r.duration>30?(we.reason+=". Shortening "+r.duration+"m long zero temp to 30m. ",we.deliverAt=De,we.temp="absolute",we.duration=30,we.rate=0,we):(we.reason+=". Temp "+r.rate+" <= current basal "+o(Ce,2)+"U/hr; doing nothing. ",we);var Le,We,ze,He,Ne=C.max_iob;if(void 0!==C.min_bg&&(We=C.min_bg),void 0!==C.max_bg&&(ze=C.max_bg),void 0!==C.enableSMB_high_bg_target&&(He=C.enableSMB_high_bg_target),void 0===C.min_bg||void 0===C.max_bg)return we.error="Error: could not determine target_bg. ",we;Le=(C.min_bg+C.max_bg)/2;var Xe=1,Ye="",Ze=C.exercise_mode||C.high_temptarget_raises_sensitivity,$e=100,Ve=160;C.half_basal_exercise_target&&(Ve=C.half_basal_exercise_target),oe&&(Ve=te);var Je=1;if(Ze&&C.temptargetSet&&Le>$e||C.low_temptarget_lowers_sensitivity&&C.temptargetSet&&Le<$e){var Ke=Ve-$e;Xe=Ke*(Ke+Le-$e)<=0?C.autosens_max:Ke/(Ke+Le-$e),Je=Xe=o(Xe=Math.min(Xe,C.autosens_max),2),Ye=" from TT modifier",B+=", Ratio TT: "+Xe,process.stderr.write("Sensitivity ratio set to "+Xe+" based on temp target of "+Le+"; ")}else void 0!==G&&G&&C.enable_autosens&&!C.use_autosens_isf_to_calculate_auto_isf_sens&&(Xe=G.ratio,Ye=" from Autosens",v=", autosens:, "+o(Xe,2),process.stderr.write("Autosens ratio: "+Xe+"; "));var Qe=Je;if(Xe&&(Ce=s(C,G)*Xe,(Ce=t(Ce,C))!==Oe?process.stderr.write("Adjusting basal from "+Oe+" to "+Ce+"; "):process.stderr.write("Basal unchanged: "+Ce+"; ")),C.temptargetSet);else if(void 0!==G&&G&&(C.sensitivity_raises_target&&G.ratio<1||C.resistance_lowers_target&&G.ratio>1)){We=o((We-60)/G.ratio)+60,ze=o((ze-60)/G.ratio)+60;var er=o((Le-60)/G.ratio)+60;Le===(er=Math.max(80,er))?process.stderr.write("target_bg unchanged: "+er+"; "):process.stderr.write("target_bg from "+Le+" to "+er+"; "),Le=er}var rr=200,ar=200,tr=200;if(e.noise>=2){var or=Math.max(1.1,C.noisyCGMTargetMultiplier);Math.min(250,C.maxRaw);rr=o(Math.min(200,We*or)),ar=o(Math.min(200,Le*or)),tr=o(Math.min(200,ze*or)),process.stderr.write("Raising target_bg for noisy / raw CGM data, from "+Le+" to "+ar+"; "),We=rr,Le=ar,ze=tr}var nr=.5;C.smb_threshold_ratio>.5&&C.smb_threshold_ratio<=1&&(nr=C.smb_threshold_ratio);var ir=We-(1-nr)*(We-40);console.log("SMB Threshold set to "+nr+" - no SMB's applied below "+n(ir,C));var sr=o(C.sens,1),lr=C.sens;void 0!==G&&G&&((lr=o(lr=C.sens/Xe,1))!==sr?process.stderr.write("ISF from "+n(sr,C)+" to "+n(lr,C)):process.stderr.write("ISF unchanged: "+n(lr,C))),console.error("CR: "+C.carb_ratio),console.error("----------------------------------"),console.error(" start autoISF"),console.error("----------------------------------");var ur=!0,mr=!1,dr=r.rate,cr=C.b30_duration,pr=cr+1;if(console.error("B30 enabled: "+C.use_B30),C.use_B30&&C.use_autoisf){var br=C.iTime_Start_Bolus,fr=C.iTime_target,gr=C.b30_upperBG,hr=C.b30_upperdelta,Br=C.b30_factor,_r=!1;C.temptargetSet&&(_r=!0);var vr=ge;0==vr&&(vr=1);var Mr=fe;console.error("B30 last bolus above limit of "+br+"U was "+Mr+"U, "+vr+"m ago"),Mr>=br&&vr<=cr&&_r&&Le==fr&&(pr=vr,mr=!0,console.error("B30 iTime is running : "+pr+"m because manual bolus ("+Mr+") >= Minimum Start Bolus size ("+br+") and EatingSoon TT set at "+n(fr,C))),console.error("B30 Activation: "+mr),console.error("B30 TTset: "+_r+", at "+Le+", last Bolus of "+Mr+"U, "+vr+"m ago. iTime remaining: "+(cr-pr)+"m."),mr&&(e.delta<=hr&&Pe<gr&&(ur=!1),pr<=cr&&(dr=t(Ce*Br,C),_="AIMI B30, Temp "+dr+"U/hr for "+(cr-pr)+"m, "))}var Sr=T(R,C,a,ur,Qe),xr=!1;if(R&&"oref"!=Sr?("enforced"!=Sr&&"fullLoop"!=Sr||(xr=!0),console.error("loop_smb function overriden with autoISF checks, enableSMB = "+xr)):(xr=function(e,r,a,t,o,i){return r?!e.allowSMB_with_high_temptarget&&e.temptargetSet&&o>100?(console.error("SMB disabled due to high temptarget of "+o),!1):!0===a.bwFound&&!1===e.A52_risk_enable?(console.error("SMB disabled due to Bolus Wizard activity in the last 6 hours."),!1):!0===e.enableSMB_always?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled due to enableSMB_always"),!0):!0===e.enableSMB_with_COB&&a.mealCOB?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for COB of"+a.mealCOB),!0):!0===e.enableSMB_after_carbs&&a.carbs?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for 6h after carb entry"),!0):!0===e.enableSMB_with_temptarget&&e.temptargetSet&&o<100?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for temptarget of "+n(o,e)),console.error("SMB enabled for temptargets with "+n(o,e)),!0):!0===e.enableSMB_high_bg&&null!==i&&t>=i?(console.error("Checking BG to see if High for SMB enablement."),console.error("Current BG",t," | High BG ",i),a.bwFound?console.error("Warning: High BG SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("High BG detected. Enabling SMB."),!0):(console.error("SMB disabled (no enableSMB preferences active or no condition satisfied)"),!1):(console.error("SMB disabled (!microBolusAllowed)"),!1)}(C,R,U,Pe,Le,He),console.error("loop_smb function returns enableSMB = "+xr)),lr=function(e,r,a,t,s,B,_,v,F,T,C,G){if(!t.use_autoisf)return console.error("autoISF disabled in Preferences"),l+=", autoISF disabled",e;if(t.autoISF_off_Sport&&(t.high_temptarget_raises_sensitivity||t.exercise_mode)&&t.temptargetSet&&a>G)return console.error("autoISF disabled due to exercise"),l+=", autoISF disabled (exercise)",e;const U=s.dura_p,A=s.delta_pl,R=s.delta_pn,P=s.r_squ,E=s.bg_acceleration,j=s.a_0,k=s.a_1,q=s.a_2,L=s.dura_ISF_minutes,W=s.dura_ISF_average;t.autoISF_min;var z=t.autoISF_max,H=!1,N=e,X=a+10-s.glucose,Y=s.pp_debug;if("bg_acceleration: "+o(E,3)+", PF-minutes: "+U+", PF-corr: "+o(P,4)+", PF-nextDelta: "+n(R,t)+", PF-lastDelta: "+n(A,t)+", regular Delta: "+n(s.delta,t),console.error(Y),t.enable_BG_acceleration){var Z=P;if(0!=q&&Z>=.9){var $=-k/2/q*5,V=o(j-$*$/25*q,1);($=o($,1))>0&&E<0?(f="predicts a Max of "+n(V,t)+", in about "+Math.abs($)+"min",console.error("Parabolic fit "+f)):$>0&&E>0?(f="predicts a Min of "+n(V,t)+", in about "+Math.abs($)+"min",console.error("Parabolic fit "+f),$<=30&&V<a&&(S=-t.bgBrake_ISF_weight,f="predicts BG below target soon, applying bgBrake ISF weight of "+-S,console.error("Parabolic fit "+f))):$<0&&E<0?(f="saw Max of "+n(V,t)+", about "+Math.abs($)+"min ago",console.error("Parabolic fit "+f)):$<0&&E>0&&(f="saw Min of "+n(V,t)+", about "+Math.abs($)+"min ago",console.error("Parabolic fit "+f))}if(Z<.9)f="acce_ISF by-passed, as correlation, "+o(Z,2)+", is too low",console.error("Parabolic fit "+f),p+=", Parabolic Fit:, "+f;else{var J=10*(Z-.9),K=1;1==S&&s.glucose<t.target_bg?E>0?(E>1&&(K=.5),S=t.bgBrake_ISF_weight):E<0&&(S=t.bgAccel_ISF_weight):1==S&&(E<0?S=t.bgBrake_ISF_weight:E>0&&(S=t.bgAccel_ISF_weight)),(M=1+E*K*S*J)<0&&(M=.1),console.error(p+"acce_ISF adaptation is "+o(M,2)),1!=M&&(H=!0,p+=", Parabolic Fit:, "+f+", acce-ISF Ratio:, "+o(M,2))}}else console.error("autoISF BG accelertion adaption disabled in Preferences");l+=u+p+", autoISF",x=1+D(100-X,t,"bg"),console.error("bg_ISF adaptation is "+o(x,2));var Q=1,ee=1;if(x<1)return Q=Math.min(x,M),M>1?(b="bg-ISF adaptation lifted to "+o(Q=x*M,2)+", as BG accelerates already",console.error(b),l+=", bg-ISF Ratio: "+o(Q,2)+"(accel.)"):l+=", bg-ISF Ratio: "+o(Q,2)+"(minimal)",ee=O(Q,t.autoISF_min,z,F,r,t,C,a,G),N=Math.min(720,o(i(t,v)/ee,1)),l+=", final Ratio: "+o(ee,2)+h+g+", final ISF: "+function(e,r){return e.use_autosens_isf_to_calculate_auto_isf_sens&&r&&r.ratio?n(e.sens,e)+"→"+n(i(e,r),e)+"→"+n(N,e):n(e.sens,e)+"→"+n(N,e)}(t,v),N;x>1&&(H=!0,l+=", bg-ISF Ratio: "+o(x,2));var re=s.delta,ae=new Date,te="";_&&(ae=new Date(_)),t.enable_pp_ISF_always||t.pp_ISF_hours>=(ae-new Date(B.lastCarbTime))/1e3/3600?deltaType="pp":deltaType="delta",X>0?console.error(deltaType+"_ISF adaptation by-passed as average glucose < "+a+"+10"):s.short_avgdelta<0?console.error(deltaType+"_ISF adaptation by-passed as no rise or too short lived"):"pp"==deltaType?(I=1+Math.max(0,re*t.pp_ISF_weight),t.enable_pp_ISF_always||(te=", last Meal "+o((ae-B.lastCarbTime)/1e3/3600,1)+" hrs ago is within Range of "+t.pp_ISF_hours+" hrs."),console.error("pp_ISF adaptation is "+o(I,2)+te),d=", pp-ISF Ratio: "+o(I,2),1!=I&&(H=!0)):(y=D(re,t,"delta"),X>-20&&(y*=.5),y=1+y,console.error("delta_ISF adaptation is "+o(y,2)),c=", Δ-ISF Ratio: "+o(y,2),1!=y&&(H=!0));var oe=t.dura_ISF_weight;B.mealCOB>0&&!t.enableautoisf_with_COB?console.error("dura_ISF by-passed; preferences disabled mealCOB of "+o(B.mealCOB,1)):L<10?console.error("dura_ISF by-passed; BG is only "+L+"m at level "+W):W<=a?console.error("dura_ISF by-passed; avg. glucose "+W+" below target "+n(a,t)):(w+=L/60*(oe/a)*(W-a),H=!0,m=", Duration: "+L+", Avg: "+n(W,t)+", dura-ISF Ratio: "+o(w,2),console.error("dura_ISF adaptation is "+o(w,2)+" because ISF "+e+" did not do it for "+o(L,1)+"m"));if(H)return Q=Math.max(w,x,y,M,I),console.error("autoISF adaption ratios:"),console.error("  acce "+o(M,2)),console.error("  bg "+o(x,2)),console.error("  dura "+o(w,2)),console.error("  pp "+o(I,2)),console.error("  delta "+o(y,2)),M<1&&(b="strongest autoISF factor "+o(Q,2)+" weakened to "+o(Q*M,2)+" as bg decelerates already",console.error(b),Q*=M),ee=O(Q,t.autoISF_min,z,F,r,t,C,a,G),N=o(i(t,v)/ee,1),l+=d+c+m+", final Ratio: "+o(ee,2)+h+g+", final ISF: "+function(e,r){return e.use_autosens_isf_to_calculate_auto_isf_sens&&r&&r.ratio?n(e.sens,e)+"→"+n(i(e,r),e)+"→"+n(N,e):n(e.sens,e)+"→"+n(N,e)}(t,v),N;return l+=", not modified",console.error("autoISF does not modify"),N}(lr,Ye,Le,C,e,U,E,G,Xe,0,Ze,$e),console.error("----------------------------------"),console.error(" end autoISF"),console.error("----------------------------------"),void 0===a)return we.error="Error: iob_data undefined. ",we;var yr,Ir=a;if(a.length,a.length>1&&(a=Ir[0]),void 0===a.activity||void 0===a.iob)return we.error="Error: iob_data missing some property. ",we;var wr=((yr=void 0!==a.lastTemp?o((new Date(Ge).getTime()-a.lastTemp.date)/6e4):0)+r.duration)%30;if(console.error("currenttemp:"+r.rate+" lastTempAge:"+yr+"m, tempModulus:"+wr+"m"),we.temp="absolute",we.deliverAt=De,R&&r&&a.lastTemp&&r.rate!==a.lastTemp.rate&&yr>10&&r.duration)return we.reason="Warning: currenttemp rate "+r.rate+" != lastTemp rate "+a.lastTemp.rate+" from pumphistory; canceling temp",A.setTempBasal(0,0,C,we,r);if(r&&a.lastTemp&&r.duration>0){var Fr=yr-a.lastTemp.duration;if(Fr>5&&yr>10)return we.reason="Warning: currenttemp running but lastTemp from pumphistory ended "+Fr+"m ago; canceling temp",A.setTempBasal(0,0,C,we,r)}var Tr=o(-a.activity*lr*5,2),Dr=o(6*(je-Tr));Dr<0&&(Dr=o(6*(ke-Tr)))<0&&(Dr=o(6*(e.long_avgdelta-Tr)));var Or=Pe,Cr=(Or=a.iob>0?o(Pe-a.iob*lr):o(Pe-a.iob*Math.min(lr,C.sens)))+Dr;if(void 0===Cr||isNaN(Cr))return we.error="Error: could not calculate eventualBG. Sensitivity: "+lr+" Deviation: "+Dr,we;var Gr=function(e,r,a){return o(a+(e-r)/24,1)}(Le,Cr,Tr);we={temp:"absolute",bg:n(Pe,C),tick:Ue,eventualBG:Cr,insulinReq:0,reservoir:P,deliverAt:De,sensitivityRatio:Xe,TDD:Ie,insulin:ye,avgDelta:n(ne,C)};var Ur=[],Ar=[],Rr=[],Pr=[];Ur.push(Pe),Ar.push(Pe),Pr.push(Pe),Rr.push(Pe);var Er=C.enableUAM,jr=0,kr=0;jr=o(je-Tr,1);var qr=o(je-Tr,1);csf=lr/C.carb_ratio,console.error("profile.sens:"+n(i(C,G),C)+", sens:"+n(lr,C)+", CSF:"+o(csf,1));var Lr=o(30*csf*5/60,1);jr>Lr&&(console.error("Limiting carb impact from "+jr+" to "+Lr+"mg/dL/5m (30g/h)"),jr=Lr);var Wr=3;Xe&&(Wr/=Xe);var zr=Wr;if(U.carbs){Wr=Math.max(Wr,U.mealCOB/20);var Hr=o((new Date(Ge).getTime()-U.lastCarbTime)/6e4),Nr=(U.carbs-U.mealCOB)/U.carbs;zr=o(zr=Wr+1.5*Hr/60,1),console.error("Last carbs "+Hr+" minutes ago; remainingCATime:"+zr+"hours; "+o(100*Nr)+"% carbs absorbed")}var Xr=Math.max(0,jr/5*60*zr/2)/csf,Yr=90,Zr=1;C.remainingCarbsCap&&(Yr=Math.min(90,C.remainingCarbsCap)),C.remainingCarbsFraction&&(Zr=Math.min(1,C.remainingCarbsFraction));var $r=1-Zr,Vr=Math.max(0,U.mealCOB-Xr-U.carbs*$r),Jr=(Vr=Math.min(Yr,Vr))*csf*5/60/(zr/2),Kr=o(U.slopeFromMaxDeviation,2),Qr=o(U.slopeFromMinDeviation,2),ea=Math.min(Kr,-Qr/3),ra=0;0===jr?kr=0:!0===C.floating_carbs?(kr=Math.min(60*zr/5/2,Math.max(0,U.carbs*csf/jr)),ra=Math.min(60*zr/5/2,Math.max(0,U.mealCOB*csf/jr)),U.carbs>0&&(l+=", Floating Carbs:, CID: "+o(kr,1)+", MealCarbs: "+o(U.carbs,1)+", Not Floating:, CID: "+o(ra,1)+", MealCOB: "+o(U.mealCOB,1),console.error("Floating Carbs CID: "+o(kr,1)+" / MealCarbs: "+o(U.carbs,1)+" vs. Not Floating:"+o(ra,1)+" / MealCOB:"+o(U.mealCOB,1)))):kr=Math.min(60*zr/5/2,Math.max(0,U.mealCOB*csf/jr)),console.error("Carb Impact:"+jr+"mg/dL per 5m; CI Duration:"+o(5*kr/60*2,1)+"hours; remaining CI ("+o(zr/2,2)+"h peak):",o(Jr,1)+"mg/dL per 5m");var aa,ta,oa,na,ia,sa=999,la=999,ua=999,ma=Pe,da=999,ca=999,pa=999,ba=999,fa=Cr,ga=Pe,ha=Pe,Ba=0,_a=[],va=[];try{Ir.forEach((function(e){var r=o(-e.activity*lr*5,2),a=o(-e.iobWithZeroTemp.activity*lr*5,2),t=jr*(1-Math.min(1,Ar.length/12));fa=Ar[Ar.length-1]+r+t;var n=Pr[Pr.length-1]+a,i=Math.max(0,Math.max(0,jr)*(1-Ur.length/Math.max(2*kr,1))),s=Math.min(Ur.length,12*zr-Ur.length),l=Math.max(0,s/(zr/2*12)*Jr);i+l,_a.push(o(l,0)),va.push(o(i,0)),COBpredBG=Ur[Ur.length-1]+r+Math.min(0,t)+i+l;var u=Math.max(0,qr+Rr.length*ea),m=Math.max(0,qr*(1-Rr.length/Math.max(36,1))),d=Math.min(u,m);d>0&&(Ba=o(5*(Rr.length+1)/60,1)),UAMpredBG=Rr[Rr.length-1]+r+Math.min(0,t)+d,Ar.length<48&&Ar.push(fa),Ur.length<48&&Ur.push(COBpredBG),Rr.length<48&&Rr.push(UAMpredBG),Pr.length<48&&Pr.push(n),COBpredBG<da&&(da=o(COBpredBG)),UAMpredBG<ca&&(ca=o(UAMpredBG)),fa<pa&&(pa=o(fa)),n<ba&&(ba=o(n));Ar.length>18&&fa<sa&&(sa=o(fa)),fa>ga&&(ga=fa),(kr||Jr>0)&&Ur.length>18&&COBpredBG<la&&(la=o(COBpredBG)),(kr||Jr>0)&&COBpredBG>ga&&(ha=COBpredBG),Er&&Rr.length>12&&UAMpredBG<ua&&(ua=o(UAMpredBG)),Er&&UAMpredBG>ga&&UAMpredBG}))}catch(e){console.error("Problem with iobArray.  Optional feature Advanced Meal Assist disabled")}we.predBGs={},Ar.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))}));for(var Ma=Ar.length-1;Ma>12&&Ar[Ma-1]===Ar[Ma];Ma--)Ar.pop();for(we.predBGs.IOB=Ar,oa=o(Ar[Ar.length-1]),Pr.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),Ma=Pr.length-1;Ma>6&&!(Pr[Ma-1]>=Pr[Ma]||Pr[Ma]<=Le);Ma--)Pr.pop();if(we.predBGs.ZT=Pr,o(Pr[Pr.length-1]),U.mealCOB>0&&(jr>0||Jr>0)){for(Ur.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),Ma=Ur.length-1;Ma>12&&Ur[Ma-1]===Ur[Ma];Ma--)Ur.pop();we.predBGs.COB=Ur,na=o(Ur[Ur.length-1]),Cr=Math.max(Cr,o(Ur[Ur.length-1]))}if(jr>0||Jr>0){if(Er){for(Rr.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),Ma=Rr.length-1;Ma>12&&Rr[Ma-1]===Rr[Ma];Ma--)Rr.pop();we.predBGs.UAM=Rr,ia=o(Rr[Rr.length-1]),Rr[Rr.length-1]&&(Cr=Math.max(Cr,o(Rr[Rr.length-1])))}we.eventualBG=Cr}console.error("UAM Impact:"+qr+"mg/dL per 5m; UAM Duration:"+Ba+"hours"),sa=Math.max(39,sa),la=Math.max(39,la),ua=Math.max(39,ua),aa=o(sa);var Sa=U.mealCOB/U.carbs;ta=o(ua<999&&la<999?(1-Sa)*UAMpredBG+Sa*COBpredBG:la<999?(fa+COBpredBG)/2:ua<999?(fa+UAMpredBG)/2:fa),ba>ta&&(ta=ba),ma=o(ma=kr||Jr>0?Er?Sa*da+(1-Sa)*ca:da:Er?ca:pa);var xa=ua;if(ba<ir)xa=(ua+ba)/2;else if(ba<Le){var ya=(ba-ir)/(Le-ir);xa=(ua+(ua*ya+ba*(1-ya)))/2}else ba>ua&&(xa=(ua+ba)/2);if(xa=o(xa),U.carbs)if(!Er&&la<999)aa=o(Math.max(sa,la));else if(la<999){var Ia=Sa*la+(1-Sa)*xa;aa=o(Math.max(sa,la,Ia))}else aa=Er?xa:ma;else Er&&(aa=o(Math.max(sa,xa)));aa=Math.min(aa,ta),process.stderr.write("minPredBG: "+n(aa,C)+" minIOBPredBG: "+n(sa,C)+" minZTGuardBG: "+n(ba,C)),la<999&&process.stderr.write(" minCOBPredBG: "+n(la,C)),ua<999&&process.stderr.write(" minUAMPredBG: "+n(ua,C)),console.error(" avgPredBG:"+n(ta,C)+" COB/Carbs:"+U.mealCOB+"/"+U.carbs),ha>Pe&&(aa=Math.min(aa,ha)),we.COB=U.mealCOB,we.IOB=a.iob,we.BGI=n(Tr,C),we.deviation=n(Dr,C),we.dura_ISFratio=o(w,2),we.bg_ISFratio=o(x,2),we.delta_ISFratio=o(y,2),we.pp_ISFratio=o(I,2),we.acce_ISFratio=o(M,2),we.auto_ISFratio=o(i(C,G)/lr,2),we.ISF=n(lr,C),we.CR=o(C.carb_ratio,2),we.TDD=o(Ie,1),we.TDDytd=o(re,1),we.TDD7d=o(ae,1),we.target_bg=n(Le,C),we.minDelta=je,we.expectedDelta=Gr,we.minGuardBG=ma,we.minPredBG=aa;var wa=function(e,r,a,t){if(!e.use_autoisf)return console.error("autoISF disabled, don't adjust SMB Delivery Ratio"),.5;var n=e.smb_delivery_ratio_bg_range;n<10&&(n/=.0555);var i=e.smb_delivery_ratio,s=Math.min(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max),l=Math.max(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max),u=a+n,m=i;return n>0&&(m=s+(l-s)*(r-a)/n,m=Math.max(s,Math.min(l,m))),"fullLoop"==t?(console.error("SMB delivery ratio set to "+o(Math.max(i,m),2)+" as max of fixed and interpolated values"),Math.max(i,m)):0==n?(console.error("SMB delivery ratio set to fixed value "+o(i,2)),i):r<=a?(console.error("SMB delivery ratio limited by minimum value "+o(s,2)),s):r>=u?(console.error("SMB delivery ratio limited by maximum value "+o(l,2)),l):(console.error("SMB delivery ratio set to interpolated value "+o(m,2)),m)}(C,Pe,Le,Sr);we.SMBratio=o(wa,2);var Fa="SMB Del.Ratio:, "+o(wa,2);let Ta="";""!==W&&"Nothing changed"!==W&&(Ta="Middleware:, "+W+", ");let Da="";C.adjust_basal_inversely_to_autosens_isf&&G&&G.newisf&&(Da="Basal: "+o(C.current_basal,2)+"→"+o(s(C,G),2)+" (asISF: "+o(G.newisf,2)+"), Autosens ratio: "+o(G.ratio,2)+", "),we.reason=Ta+Da+_+Fa+v+B+l+", Standard, COB: "+we.COB+", Dev: "+we.deviation+", BGI: "+we.BGI+", ISF: "+we.ISF+", CR: "+we.CR+", Target: "+we.target_bg+", minPredBG "+n(aa,C)+", minGuardBG "+n(ma,C)+", IOBpredBG "+n(oa,C),na>0&&(we.reason+=", COBpredBG "+n(na,C)),ia>0&&(we.reason+=", UAMpredBG "+n(ia,C)),we.reason+=tddReason,we.reason+="; ";var Oa=Or;Oa<40&&(Oa=Math.min(ma,Oa));var Ca=ir-Oa,Ga=240,Ua=240;if(U.mealCOB>0&&(jr>0||Jr>0)){for(Ma=0;Ma<Ur.length;Ma++)if(Ur[Ma]<We){Ga=5*Ma;break}for(Ma=0;Ma<Ur.length;Ma++)if(Ur[Ma]<ir){Ua=5*Ma;break}}else{for(Ma=0;Ma<Ar.length;Ma++)if(Ar[Ma]<We){Ga=5*Ma;break}for(Ma=0;Ma<Ar.length;Ma++)if(Ar[Ma]<ir){Ua=5*Ma;break}}xr&&ma<ir&&(console.error("minGuardBG "+n(ma,C)+" projected below "+n(ir,C)+" - disabling SMB"),Te=1,Fe=o((Cr-Le)/lr,2),xr=!1);var Aa=.3;"fullLoop"==Sr&&(Aa=.4),qe>Aa*Pe&&(console.error("maxDelta "+n(qe,C)+" > "+100*Aa+"% of BG "+n(Pe,C)+" - disabling SMB"),we.reason+="maxDelta "+n(qe,C)+" > "+100*Aa+"% of BG "+n(Pe,C)+" - SMB disabled!, ",xr=!1),console.error("BG projected to remain above "+n(We,C)+" for "+Ga+"minutes"),(Ua<240||Ga<60)&&console.error("BG projected to remain above "+n(ir,C)+" for "+Ua+"minutes");var Ra=Ua,Pa=s(C,G)*lr*Ra/60,Ea=Math.max(0,U.mealCOB-.25*U.carbs),ja=(Ca-Pa)/csf-Ea;if(Pa=o(Pa),ja=o(ja),console.error("naive_eventualBG: "+n(Or,C)+", bgUndershoot: "+n(Ca,C)+", zeroTempDuration: "+Ra+", zeroTempEffect: "+Pa+", carbsReq: "+ja),"Could not parse clock data"==U.reason?console.error("carbsReq unknown: Could not parse clock data"):ja>=C.carbsReqThreshold&&Ua<=45&&(we.carbsReq=ja,we.reason+=ja+" add'l carbs req w/in "+Ua+"m; "),mr&&pr<=cr)return we.reason+="setting AIMI B30 Temp "+t(dr,C)+"U/hr for "+(cr-pr)+"m ",we.temp="absolute",we.deliverAt=De,we.duration=Math.min(30,cr-pr),console.error("Forcing AIMI temp "+dr+"U/hr"),A.setTempBasal(dr,30,C,we,r);var ka=0;if(Pe<ir&&a.iob<20*-s(C,G)/60&&je>0&&je>Gr)we.reason+="IOB "+a.iob+" < "+o(20*-s(C,G)/60,2),we.reason+=" and minDelta "+n(je,C)+" > expectedDelta "+n(Gr,C)+"; ";else if(Pe<ir||ma<ir)return we.reason+="minGuardBG "+n(ma,C)+"<"+n(ir,C),ma<ir&&(Te=2),Fe=o((Cr-Le)/lr,2),ka=o(60*((Ca=Le-ma)/lr)/s(C,G)),ka=30*o(ka/30),ka=Math.min(120,Math.max(30,ka)),A.setTempBasal(0,ka,C,we,r);if(C.skip_neutral_temps&&we.deliverAt.getMinutes()>=55){if(!xr)return we.reason+="; Canceling temp at "+(60-we.deliverAt.getMinutes())+"min before turn of the hour to avoid beeping of MDT. SMB disabled anyways.",A.setTempBasal(0,0,C,we,r);console.error(60-we.deliverAt.getMinutes()+"min before turn of the hour, but SMB's are enabled - no skipping neutral temps")}var qa=0,La=Ce;if(Cr<We){if(we.reason+="Eventual BG "+n(Cr,C)+" < "+n(We,C),je>Gr&&je>0&&!ja)return Or<40?(we.reason+=", naive_eventualBG < 40. ",A.setTempBasal(0,30,C,we,r)):(e.delta>je?we.reason+=", but Delta "+n(Ue,C)+" > expectedDelta "+n(Gr,C):we.reason+=", but Min. Delta "+je.toFixed(2)+" > Exp. Delta "+n(Gr,C),r.duration>15&&t(Ce,C)===t(r.rate,C)?(we.reason+=", temp "+r.rate+" ~ req "+o(Ce,2)+"U/hr. ",we):(we.reason+="; setting current basal of "+o(Ce,2)+" as temp. ",A.setTempBasal(Ce,30,C,we,r)));qa=o(qa=2*Math.min(0,(Cr-Le)/lr),2);var Wa=Math.min(0,(Or-Le)/lr);if(Wa=o(Wa,2),je<0&&je>Gr)qa=o(qa*(je/Gr),2);if(La=t(La=Ce+2*qa,C),r.duration*(r.rate-Ce)/60<Math.min(qa,Wa)-.3*Ce)return we.reason+=", "+r.duration+"m@"+r.rate.toFixed(2)+" is a lot less than needed. ",A.setTempBasal(La,30,C,we,r);if(void 0!==r.rate&&r.duration>5&&La>=.8*r.rate)return we.reason+=", temp "+r.rate+" ~< req "+o(La,2)+"U/hr. ",we;if(La<=0){if((ka=o(60*((Ca=Le-Or)/lr)/s(C,G)))<0?ka=0:(ka=30*o(ka/30),ka=Math.min(120,Math.max(0,ka))),ka>0)return we.reason+=", setting "+ka+"m zero temp. ",A.setTempBasal(La,ka,C,we,r)}else we.reason+=", setting "+o(La,2)+"U/hr. ";return A.setTempBasal(La,30,C,we,r)}if(je<Gr&&(we.minDelta=je,we.expectedDelta=Gr,(Gr-je>=2||Gr+-1*je>=2)&&(Te=je>=0&&Gr>0?3:je<0&&Gr<=0||je<0&&Gr>=0?4:5),Fe=o((Cr-Le)/lr,2),!R||!xr))return e.delta<je?we.reason+="Eventual BG "+n(Cr,C)+" > "+n(We,C)+" but Delta "+n(Ue,C)+" < Exp. Delta "+n(Gr,C):we.reason+="Eventual BG "+n(Cr,C)+" > "+n(We,C)+" but Min. Delta "+je.toFixed(2)+" < Exp. Delta "+n(Gr,C),r.duration>15&&t(Ce,C)===t(r.rate,C)?(we.reason+=", temp "+r.rate+" ~ req "+Ce+"U/hr. ",we):(we.reason+="; setting current basal of "+Ce+" as temp. ",A.setTempBasal(Ce,30,C,we,r));if(Math.min(Cr,aa)<ze&&(aa<We&&Cr>We&&(Te=6,Fe=o((Cr-Le)/lr,2)),!R||!xr))return we.reason+=n(Cr,C)+"-"+n(aa,C)+" in range: no temp required",r.duration>15&&t(Ce,C)===t(r.rate,C)?(we.reason+=", temp "+r.rate+" ~ req "+Ce+"U/hr. ",we):(we.reason+="; setting current basal of "+Ce+" as temp. ",A.setTempBasal(Ce,30,C,we,r));if(Cr>=ze&&(we.reason+="Eventual BG "+n(Cr,C)+" >= "+n(ze,C)+", "),a.iob>Ne)return we.reason+="IOB "+o(a.iob,2)+" > maxIOB "+Ne,r.duration>15&&t(Ce,C)===t(r.rate,C)?(we.reason+=", temp "+r.rate+" ~ req "+Ce+"U/hr. ",we):(we.reason+="; setting current basal of "+Ce+" as temp. ",A.setTempBasal(Ce,30,C,we,r));qa=o((Math.min(aa,Cr)-Le)/lr,2),Fe=o((Cr-Le)/lr,2),qa>Ne-a.iob?(we.reason+="maxIOB "+Ne+", ",console.error("InsReq "+o(qa,2)+" capped at "+o(Ne-a.iob,2)+" to not exceed maxIOB"),qa=Ne-a.iob):console.error("SMB not limited by maxIOB (insulinReq: "+qa+" U)"),Fe>Ne-a.iob?console.error("Ev. Bolus limited by maxIOB to "+o(Ne-a.iob,2)+" (insulinForManualBolus: "+Fe+" U)"):console.error("Ev. Bolus would not be limited by maxIOB (insulinForManualBolus: "+Fe+" U)."),La=t(La=Ce+2*qa,C),qa=o(qa,3),we.insulinReq=qa,we.insulinForManualBolus=o(Fe,2),we.manualBolusErrorString=Te,we.minDelta=je,we.expectedDelta=Gr,we.minGuardBG=ma,we.minPredBG=aa,we.threshold=n(ir,C),we.reason="Ins.Req: "+o(qa,2)+", "+we.reason;var za=o((new Date(Ge).getTime()-a.lastBolusTime)/6e4,1);if(R&&xr&&Pe>ir){var Ha=o(U.mealCOB/C.carb_ratio,3);if(C.use_autoisf)Na=C.smb_max_range_extension;else{console.error("autoISF disabled, SMB range extension disabled");var Na=1}Na>1&&console.error("SMB max range extended from default by factor "+Na);var Xa=0;void 0===C.maxSMBBasalMinutes?(Xa=o(Na*s(C,G)*30/60,1),console.error("profile.maxSMBBasalMinutes undefined: defaulting to 30m")):a.iob>Ha&&a.iob>0?(console.error("IOB "+a.iob+" > COB "+U.mealCOB+"; mealInsulinReq = "+Ha),C.maxUAMSMBBasalMinutes?(console.error("profile.maxUAMSMBBasalMinutes:",C.maxUAMSMBBasalMinutes,"getBasalValue(profile, autosens_data):",s(C,G)),Xa=o(Na*s(C,G)*C.maxUAMSMBBasalMinutes/60,1)):(console.error("profile.maxUAMSMBBasalMinutes undefined: defaulting to 30m"),Xa=o(30*s(C,G)/60,1))):(console.error("profile.maxSMBBasalMinutes:",C.maxSMBBasalMinutes,"getBasalValue(profile, autosens_data):",s(C,G)),Xa=o(Na*s(C,G)*C.maxSMBBasalMinutes/60,1));var Ya=C.bolus_increment,Za=1/Ya;C.use_autoisf||(console.error("autoISF disabled, don't adjust SMB Delivery Ratio"),wa=.5),wa>.5&&console.error("SMB Delivery Ratio increased from default 0.5 to "+o(wa,2));var $a=Math.min(qa*wa,Xa),Va="",Ja=F/100*130/100*C.max_iob*Qe;$a>Ja-a.iob&&("fullLoop"==Sr||"enforced"==Sr)&&($a=Ja-a.iob,Va=", capped by autoISF iobTH",console.error("autoISF capped SMB at "+o($a,2)+" to not exceed 130% of effective iobTH "+o(Ja/130*100,2)+"U")),$a=Math.floor($a*Za)/Za,ka=o(60*((Le-(Or+sa)/2)/lr)/s(C,G)),qa>0&&$a<Ya&&(ka=0);var Ka=0;ka<=0?ka=0:ka>=30?(ka=30*o(ka/30),ka=Math.min(60,Math.max(0,ka))):(Ka=o(Ce*ka/30,2),ka=30),we.reason+=" insulinReq "+qa,$a>=Xa&&(we.reason+="; maxBolus "+Xa),ka>0&&(we.reason+="; setting "+ka+"m low temp of "+Ka+"U/h"),we.reason+=". ";var Qa=3;C.SMBInterval&&(Qa=Math.min(10,Math.max(1,C.SMBInterval)));var et=o(Qa-za,0),rt=o(60*(Qa-za),0)%60;if(console.error("naive_eventualBG "+n(Or,C)+", "+ka+"m "+Ka+"U/h temp needed; last bolus "+za+"m ago; maxBolus: "+Xa),za>Qa?$a>0&&(we.units=$a,we.reason+="Microbolusing "+$a+"U"+Va+". "):we.reason+="Waiting "+et+"m "+rt+"s to microbolus again. ",ka>0)return we.rate=Ka,we.duration=ka,we}var at=A.getMaxSafeBasal(C);return La>at&&(we.reason+="adj. req. rate: "+o(La,2)+" to maxSafeBasal: "+o(at,2)+", ",La=t(at/function(e,r){return e.adjust_basal_inversely_to_autosens_isf&&r&&r.newisf?r.ratio:1}(C,G),C)),r.duration*(r.rate-Ce)/60>=2*qa?(we.reason+=r.duration+"m@"+r.rate.toFixed(2)+" > 2 * insulinReq. Setting temp basal of "+La+"U/hr. ",A.setTempBasal(La,30,C,we,r)):void 0===r.duration||0===r.duration?(we.reason+="no temp, setting "+La+"U/hr. ",A.setTempBasal(La,30,C,we,r)):r.duration>5&&t(La,C)<=t(r.rate,C)?(we.reason+="temp "+r.rate+" >~ req "+La+"U/hr. ",we):(we.reason+="temp "+r.rate+"<"+La+"U/hr. ",A.setTempBasal(La,30,C,we,r))}},3531:(e,r,a)=>{var t=a(2296);e.exports=function(e,r){var a=20;void 0!==r&&"string"==typeof r.model&&(t(r.model,"54")||t(r.model,"23"))&&(a=40);return e<1?Math.round(e*a)/a:e<10?Math.round(20*e)/20:Math.round(10*e)/10}},1873:(e,r,a)=>{var t=a(9325).Symbol;e.exports=t},4932:e=>{e.exports=function(e,r){for(var a=-1,t=null==e?0:e.length,o=Array(t);++a<t;)o[a]=r(e[a],a,e);return o}},7133:e=>{e.exports=function(e,r,a){return e==e&&(void 0!==a&&(e=e<=a?e:a),void 0!==r&&(e=e>=r?e:r)),e}},2552:(e,r,a)=>{var t=a(1873),o=a(659),n=a(9350),i=t?t.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":i&&i in Object(e)?o(e):n(e)}},7556:(e,r,a)=>{var t=a(1873),o=a(4932),n=a(6449),i=a(4394),s=t?t.prototype:void 0,l=s?s.toString:void 0;e.exports=function e(r){if("string"==typeof r)return r;if(n(r))return o(r,e)+"";if(i(r))return l?l.call(r):"";var a=r+"";return"0"==a&&1/r==-1/0?"-0":a}},4128:(e,r,a)=>{var t=a(1800),o=/^\s+/;e.exports=function(e){return e?e.slice(0,t(e)+1).replace(o,""):e}},4840:(e,r,a)=>{var t="object"==typeof a.g&&a.g&&a.g.Object===Object&&a.g;e.exports=t},659:(e,r,a)=>{var t=a(1873),o=Object.prototype,n=o.hasOwnProperty,i=o.toString,s=t?t.toStringTag:void 0;e.exports=function(e){var r=n.call(e,s),a=e[s];try{e[s]=void 0;var t=!0}catch(e){}var o=i.call(e);return t&&(r?e[s]=a:delete e[s]),o}},9350:e=>{var r=Object.prototype.toString;e.exports=function(e){return r.call(e)}},9325:(e,r,a)=>{var t=a(4840),o="object"==typeof self&&self&&self.Object===Object&&self,n=t||o||Function("return this")();e.exports=n},1800:e=>{var r=/\s/;e.exports=function(e){for(var a=e.length;a--&&r.test(e.charAt(a)););return a}},2296:(e,r,a)=>{var t=a(7133),o=a(7556),n=a(1489),i=a(3222);e.exports=function(e,r,a){e=i(e),r=o(r);var s=e.length,l=a=void 0===a?s:t(n(a),0,s);return(a-=r.length)>=0&&e.slice(a,l)==r}},6449:e=>{var r=Array.isArray;e.exports=r},3805:e=>{e.exports=function(e){var r=typeof e;return null!=e&&("object"==r||"function"==r)}},346:e=>{e.exports=function(e){return null!=e&&"object"==typeof e}},4394:(e,r,a)=>{var t=a(2552),o=a(346);e.exports=function(e){return"symbol"==typeof e||o(e)&&"[object Symbol]"==t(e)}},7400:(e,r,a)=>{var t=a(6993),o=1/0;e.exports=function(e){return e?(e=t(e))===o||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}},1489:(e,r,a)=>{var t=a(7400);e.exports=function(e){var r=t(e),a=r%1;return r==r?a?r-a:r:0}},6993:(e,r,a)=>{var t=a(4128),o=a(3805),n=a(4394),i=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,l=/^0o[0-7]+$/i,u=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(n(e))return NaN;if(o(e)){var r="function"==typeof e.valueOf?e.valueOf():e;e=o(r)?r+"":r}if("string"!=typeof e)return 0===e?e:+e;e=t(e);var a=s.test(e);return a||l.test(e)?u(e.slice(2),a?2:8):i.test(e)?NaN:+e}},3222:(e,r,a)=>{var t=a(7556);e.exports=function(e){return null==e?"":t(e)}}},r={};function a(t){var o=r[t];if(void 0!==o)return o.exports;var n=r[t]={exports:{}};return e[t](n,n.exports,a),n.exports}a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}();var t=a(2982);freeaps_determineBasal=t})();
